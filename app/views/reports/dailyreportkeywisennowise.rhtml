<html>
  <head>
    <meta name="GENERATOR" content="Microsoft FrontPage 5.0"/>
    <meta name="ProgId" content="FrontPage.Editor.Document"/>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1252"/>
    <title>New Page 1</title>
    <script language="JavaScript" type="text/JavaScript">
      function saveIt()
      {
        document.execCommand("SaveAs")
      }
    </script>
  </head>

  <body>
    <h2>DAILY REPORT</h2>
    <a href="javascript:saveIt()">
      Save This Page
    </a>
    <br/>
    <p align=center>
      <font size=4>
        <b>
          Date:-&nbsp;&nbsp;&nbsp;&nbsp;<%= Date.parse(session[:dailyvalue]).strftime("%d-%m-%Y") %>
        </b>
      </font>
    </p>

    <!-- Scheduler --------------------------------------------------------------------------------------------------------------------------------------->
    <%= render :partial => 'daily_report_summary' %>
    <!-- Scheduler --------------------------------------------------------------------------------------------------------------------------------------->
    <br></br>
    <%len=@session[:shoparray1].length %>
    <% total_tsrin=0%>
    <% total_tsrout=0%>
    <% shopcount=0 %>

    <%for i in 0..len-1 do %>
      <table>
        <tr>
          <td colspan=16 align=center><font size=5><b><%= @session[:shoparray1][i].to_s%></b></font></td></tr> </table>

      <!-- Shop's HC-TOT-CR-OS-M/S ------------------------------------------------------------------------------------------------>
      <%= render :partial => 'daily_report_spl_summary' ,:locals => {:i => i}%>
      <!-- Shop's HC-TOT-CR-OS-M/S ------------------------------------------------------------------------------------------------>


      <% @key=Group.find(:all,:conditions=>["CLUSTERNAME in (?) and SHOPNAME=?",
          @session[:clustarray],@session[:shoparray1][i].to_s],:order=>'GroupID')%>
      <% @key.each do |key| %>

        <% @TotalTSRIN=0%>
        <% @TotalTSROUT=0%>
        <% @TotalMCSHORT=0%>
        <% @TotalCOLL=0 %>
      
        <% percentage = percentage_calcutation(@session[:rrclustername],@session[:shoparray1][i].to_s,key.GroupID,@session[:startdatehc],@session[:enddatehc])   %>

        <% short_extra = short_extra_values(@session[:startdatehc],@session[:enddatehc],@session[:rrclustername],@session[:shoparray1][i].to_s,key.GroupID) %>
        <table>
          <tr><td colspan=16><font size=4>
                <b><span><%= key.GroupID %>&nbsp;&nbsp;S/E&nbsp;&nbsp;<%= se_value = short_extra.blank? ? '' : font_color(short_extra)  %></span>
                  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                  <span><%= @session[:shoparray1][i].to_s%></span>&nbsp;&nbsp;
                  <%= tot_percentage_color(percentage) %></b></td>
          </tr>
        </table>
        <br></br>

        <table  border="1" width ="95%"  cellpadding="0"  cellspacing="0"  bordercolor="black"   id="AutoNumber1" >
              <tr bgcolor="#E7CF7C">
                <th height="20" bgcolor="#E7CF7C" >Machine&nbsp;Type</th>
                <th height="20" bgcolor="#E7CF7C" >No.of&nbsp;Machines</th>
                <th height="20" bgcolor="#E7CF7C" >Percentage</th>
              </tr>

              <% mac_type_name = MachineType.find(:all).each do |mac_typ_name| %>
                <% percentage_by_type = percentage_calcutation_by_type(@session[:rrclustername],@session[:shoparray1][i].to_s,key.GroupID,@session[:startdatehc],@session[:enddatehc],mac_typ_name)   %>
                <tr><td align=center width="50"><B><font size="3"><%= mac_typ_name.name %> <font/><B/></td>
                        <td align=center width="50"><B><font size="3"><%= mac_typ_name.machines.find_all_by_ClusterName_and_ShopName_and_GroupID(@session[:rrclustername],@session[:shoparray1][i].to_s,key.GroupID).count %> <font/><B/></td>
                              <td align=center width="150"><B><font size="3"><%= tot_percentage_color(percentage_by_type) %> <font/><B/></td></tr>
                                  <% end %>
             </table>
        <br></br>

        <table  border="1" width ="95%"  cellpadding="0"  cellspacing="0"  bordercolor="black"   id="AutoNumber1" >

          <tr >
            <th scope=col nowrap width="4%"  height="20">NO</th>
            <th scope=col width="6%" height="1"  >NAME</th>
            <th scope=col nowrap width="7%" height="1"  >SRIN</th>
            <th scope=col nowrap width="7%" height="1"  >SROUT</th>
            <th scope=col nowrap width="5%" height="1"  >SR %</th>
            <th scope=col nowrap width="7%" height="1"  >TSRIN</th>
            <th scope=col nowrap width="7%" height="1"  >TSROUT</th>
            <th scope=col nowrap width="7%" height="1"  >M/S</th>
            <th scope=col nowrap width="7%" height="1"  >COLL</th>
            <th scope=col nowrap width="5%" height="1"  >LOSS</th>
            <th scope=col nowrap width="7%" height="1"  >LOSS</th>
            <th scope=col nowrap width="7%" height="1"  >10 AVG</th>
            <th scope=col nowrap width="6%" height="1"  >SR AVG</th>
            <th scope=col nowrap width="7%" height="1"  >T SET</th>
            <th scope=col nowrap width="7%" height="1"  >P SET</th>
            <th scope=col nowrap width="7%" height="1"  >PM %</th>

          </tr>
          <% @machinesdata=Machinedata.find(:all,
            :conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? AND GROUP_ID=? and TRANS_DATE=?",
              @session[:clustarray],@session[:shoparray1][i].to_s,key.GroupID,session[:dailyvalue]],
            :order => "digitno,charno") %>
          <% @machinesdata.each do |c| %>
            <% @pmper=Machinedata.find(:all,
              :conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? AND GROUP_ID=? and MACHINE_NO='#{c.MACHINE_NO}'",
                @session[:clustarray],@session[:shoparray1][i].to_s,key.GroupID],
              :order => "digitno,charno") %>
            <% @tin=0%>
            <% @tout=0%>
            <% @coll=0%>
            <% for i1 in @pmper %>
              <%if(i1.CALCULATEBY=='S')%>
                <%@tin=@tin.to_i+i1.TSRIN.to_i%>
                <%@tout=@tout.to_i+i1.TSROUT.to_i%>
              <%else%>
                <%@tin=@tin.to_i+i1.TMTRIN.to_i%>
                <%@tout=@tout.to_i+i1.TMTROUT.to_i%>
              <%end%>
            <% end %>

            <!----------------------------------------------- ----------------------------------------------------------------------------->

            <% if c.CALCULATEBY == 'M'%>

              <tr bgcolor="#FFA500">
                <%  machine_color  = machine_no_and_machine_name_color(@session[:shoparray1][i].to_s,c.MACHINE_NO,c.MACHINE_NAME)%>
        <%#  machine_color  = machine_no_and_machine_name_color(c.MACHINE_NO,c.MACHINE_NAME)%>
                <td nowrap height="10" align=center bgcolor="<%= machine_color %>"><font color=blue><b><%= c.MACHINE_NO %></b></font></td>
                <td nowrap height="10" align=center bgcolor="<%= machine_color %>"><font color=blue><b><%= c.MACHINE_NAME %></b></font></td>
                <!-- display SRIN start-->
                <%if c.SRIN.to_i>=0 %>
                  <td nowrap height="10" align=center><font color=black><%= c.SRIN.to_i %></font></td>
                <%else%>
                  <td nowrap height="10" align=center><font color=red><%= c.SRIN.to_i %></font></td>
                <%end%>
                <!-- display SRIN end-->

                <!-- display SROUT start-->
                <%if c.SROUT.to_i>=0 %>
                  <td nowrap height="10" align=center><font color=black><%= c.SROUT.to_i %></font></td>
                <%else%>
                  <td nowrap height="10" align=center><font color=red><%= c.SROUT.to_i %></font></td>
                <%end%>
                <!-- display SROUT end-->

                <!-- display SR% start-->
                <%if c.SRPER.to_i <=59%>
                  <td nowrap height="10" align=center><font color= red><%= c.SRPER %>%</font></td>
                      <%elsif c.SRPER.to_i >59 and c.SRPER.to_i <=69%>
                      <td nowrap height="10" align=center><font color= blue><%= c.SRPER %>%</font></td>
                          <%elsif c.SRPER.to_i >69 and c.SRPER.to_i <=80%>
                          <td nowrap height="10" align=center><font color= green><%= c.SRPER %>%</font></td>
                              <%elsif c.SRPER.to_i >80%>
                              <td nowrap height="10" align=center><font color= red><%= c.SRPER %>%</font></td>
                                  <%end%>
                                <!-- display SR% end-->
                                <!-- display TSRIN end-->

                                <% if c.CALCULATEBY=='S'%>
                                  <% @TotalTSRIN=@TotalTSRIN.to_i+(((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round)%>
                                  <%@tsrinvalue=(((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round)%>
                                  <%if @tsrinvalue.to_i>=0 %>
                                    <td nowrap  height="10" align=center><font color=black><%= (((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round) %></font></td>
                                  <%else%>
                                    <td nowrap  height="10" align=center><font color=red><%= (((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round) %></font></td>
                                  <%end%>

                                  <% @TotalTSROUT=@TotalTSROUT.to_i+((c.TSROUT.to_i*c.MULTIPLY_BY*c.SCREEN_RATE_OUT.to_i)/10).round%>
                                  <%@tsroutvalue =(((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                  <%if @tsroutvalue.to_i>=0 %>
                                    <td nowrap  height="10" align=center><font color=black><%= (((c.TSROUT.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_OUT.to_i)/10).round) %></font></td>
                                  <%else%>
                                    <td nowrap  height="10" align=center><font color=red><%= (((c.TSROUT.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_OUT.to_i)/10).round) %></font></td>
                                  <%end%>

                                    <!--<td nowrap width="64" height="10" align=center><% (((c.TSROUT.to_i*c.MULTIPLY_BY*c.SCREEN_RATE_OUT.to_i)/10).round) %></td>-->
                                <% else %>
                                  <%@tsrinsecvalue=(((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                  <%if @tsrinsecvalue.to_i>=0 %>
                                    <td nowrap  height="10" align=center><font color=black><%= (((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                  <%else%>
                                    <td nowrap  height="10" align=center><font color=red><%= (((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                  <%end%>

                                  <% @TotalTSRIN=@TotalTSRIN.to_i+(((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                                            <!--<td nowrap  height="10" align=center><%= (((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></td>-->
                                  <% @TotalTSROUT=@TotalTSROUT.to_i+(((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTE_RATE_OUT.to_i)/10).round)%>
                                  <%@tsroutsecvalue=(((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                  <%if @tsroutsecvalue.to_i>=0 %>
                                    <td nowrap  height="10" align=center><font color=black><%= (((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                  <%else%>
                                    <td nowrap  height="10" align=center><font color=red><%= (((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                  <%end%>

                                            <!--<td nowrap width="64" height="10" align=center><%= (((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></td>-->

                                <% end %>

                                <!-- display TSRIN end-->

                                <!--<h2></td>ms-->
                                <!-- display M/S end-->

                                <%if c.MTRSHORT.to_i == 0%>
                                  <td nowrap height="10" align=center><font color= black><%= c.MTRSHORT.to_i %>  <%= c.SHORTREASON%></font></td>
                                <%elsif c.MTRSHORT.to_i <0 %>
                                  <td nowrap height="10" align=center><font color= red><b><%= c.MTRSHORT.to_i %>  <%= c.SHORTREASON%></b></font></td>
                                <%elsif c.MTRSHORT.to_i >0 %>
                                  <td nowrap height="10" align=center bgcolor=green><font color= white><b><%= c.MTRSHORT.to_i %>  <%= c.SHORTREASON%></b></font></td>
                                <%end%>
                                <!-- display M/S end-->


                                <% @TotalMCSHORT=@TotalMCSHORT.to_i+c.MTRSHORT.to_i%>
                                <% if c.CALCULATEBY=='S'%>
                                  <% @sr=c.SRCOLL*c.MULTIPLY_BY.to_i %>
                                <% else %>
                                  <% @sr=c.MTRCOLL*c.MULTIPLY_BY.to_i %>
                                <% end %>
                                <% @TotalCOLL=@TotalCOLL.to_i+@sr.to_i %>

                                <!--display Collection value start-->
                                <%if @sr >=0 %>
                                  <td nowrap height="10" align=center><font size=3 color=blue><b><%= @sr.to_i %></b></font></td>
                                <%else%>
                                  <td nowrap height="10" align=center><font  size=3 color=red><b><%= @sr.to_i %></b></font></td>
                                <%end%>
                                <!--display Collection value end-->

                                <% olddate=Date.parse("#{session[:dailyvalue]}")-5%>
                                <% @flagval="false" %>
                                <% @totalval=0%>
                                <% @mval=Machinedata.find(:first,
                                  :conditions=>['SHOP_NAME=? and GROUP_ID=? and MACHINE_NO=? and TRANS_DATE=?',
                                    @session[:shoparray1][i].to_s,key.GroupID,c.MACHINE_NO,
                                    session[:dailyvalue]],
                                  :order => "MACHINE_NAME,digitno,charno")%>
                                <% @machinevalues=Machinedata.find(:all,
                                  :conditions=>['SHOP_NAME=? and GROUP_ID=? and MACHINE_NO=? and TRANS_DATE<=? and TRANS_DATE>=?',
                                    @session[:shoparray1][i].to_s,key.GroupID,c.MACHINE_NO,session[:dailyvalue],olddate+1],
                                  :order => "TRANS_DATE")%>
                                <% @losscount=1 %>
                                <%@machinevalues.each do |item|%>
                                  <%if ((@mval.SETTING==item.SETTING) and ((item.SRIN==item.PSRINVALUE and ((item.SRIN!=0 and item.PSRINVALUE!=0) or(item.SRIN==0 and item.PSRINVALUE==0 and item.T_DATE!=nil)))   or (item.SROUT==item.PSROUTVALUE and ((item.SROUT!=0 and item.PSROUTVALUE!=0)or(item.SROUT==0 and item.PSROUTVALUE==0 and item.T_DATE!=nil))))) %>
                                    <% if item.CALCULATEBY=='S'%>
                                      <% @srval=item.SRCOLL.to_i*c.MULTIPLY_BY.to_i %>
                                    <% else %>
                                      <% @srval=item.MTRCOLL.to_i*c.MULTIPLY_BY.to_i %>
                                    <% end %>

                                    <% if @losscount.to_i<=5%>
                                      <% if @srval.to_i < 0  %>
                                        <% @flagval="true" %>
                                        <% if @lossval.to_s=='0' %>
                                          <% @lossval="*"%>
                                        <% else %>
                                          <% @lossval=@lossval.to_s+"*"%>
                                        <%end%>
                                        <% @totalval=@totalval+@srval%>

                                      <% else %>
                                        <% if @flagval=="true" %>
                                          <% if @lossval.to_s=='0' %>
                                            <% @lossval="+"%>
                                          <% else %>
                                            <% @lossval=@lossval.to_s+"+"%>
                                          <%end%>
                                          <% @totalval=@totalval+@srval%>
                                        <% end %>

                                      <% end %>
                                      <% @losscount=@losscount.to_i+1%>
                                    <% end %>

                                  <% end%>

                                <%end%>
                                <!--display Loss  value start-->

                                <% if @lossval==0%>
                                  <td nowrap height="10" align=left>&nbsp;</td>
                                <%else%>
                                  <td nowrap height="10" align=left><font size=3><%= @lossval%></font></td>
                                <% end %>
                                <!--display Loss  value end-->
                                <% @lossval=0%>
                                <% @machinevalues=Machinedata.find(:all,:conditions=>['SHOP_NAME=? and GROUP_ID=? and MACHINE_NO=? and TRANS_DATE<=?',@session[:shoparray1][i].to_s,c.GROUP_ID,c.MACHINE_NO,session[:dailyvalue]],:order => 'TRANS_DATE desc')%>
                                <%@machinevalues.each do |item|%>
                                  <% if c.SETTING!=item.SETTING %>
                                    <% @mtrper=item.MTRPER %>
                                    <% @pset=item.SETTING%>
                                    <% break%>
                                  <% else %>
                                    <% @mtrper=0 %>
                                    <% @pset='A'%>
                                  <% end %>
                                <% end %>

                                <!--display Loss AMT value start-->
                                <%if @totalval >=0 %>
                                  <td nowrap height="10" align=center ><font color=black><b><%= @totalval.to_i%></b></font></td>
                                <%else%>
                                  <td nowrap height="10" align=center ><font color=red><b><%= @totalval.to_i%></b></font></td>
                                <%end%>
                                <!--display Loss AMT  value end-->

                                <!--display  10 avg value start-->
                                <%@tenavgnew = c.TENDAYSAVG.to_i*c.MULTIPLY_BY.to_i%>
                                <%if @tenavgnew >=0 %>
                                  <td nowrap height="10" align=center><font color=black><b><%= @tenavgnew.to_i%></b></font></td>
                                <%else%>
                                  <td nowrap height="10" align=center><font color=red><b><%= @tenavgnew.to_i%></b></font></td>
                                <%end%>
                                <!--display  10 avg value end-->

                                <!--display  SR avg value end-->
                                <%@sravgvalue= (c.SRAVG*c.MULTIPLY_BY.to_i).round%>
                                <%if @sravgvalue >=0 %>
                                  <td nowrap height="10" align=center><font color=black><b><%= @sravgvalue.to_i%></b></font></td>
                                <%else%>
                                  <td nowrap height="10" align=center><font color=red><b><%= @sravgvalue.to_i%></b></font></td>
                                <%end%>
                                <!--display  SR avg value end-->

                                <% machinesetting  = Machinedata.find_by_sql("select setting from Machinedatas
          where CLUSTER_NAME='#{@session[:clustarray]}'
          and SHOP_NAME='#{@session[:shoparray1][i].to_s}'
          and machine_no='#{c.MACHINE_NO}'
          AND GROUP_ID='#{key.GroupID}'
          and TRANS_DATE<'#{session[:dailyvalue]}'
          order by TRANS_DATE desc limit 1")%>


                                <% @pmper=Machinedata.find(:all,
                                  :conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? AND GROUP_ID=? and MACHINE_NO='#{c.MACHINE_NO}'and TRANS_DATE='#{session[:dailyvalue]}'",
                                    @session[:clustarray],@session[:shoparray1][i].to_s,key.GroupID],
                                  :order => "MACHINE_NAME,digitno,charno") %>
                                <% for i1 in @pmper %>
                                  <%unless machinesetting[0].nil?%>
                                    <% if machinesetting[0].setting == i1.SETTING%>
                                      <td nowrap height="10" align=left><font color=blue><b><%= c.SETTING%></b></font></td>
                                    <% else %>
                                      <td nowrap height="10" align=left bgcolor="pink"><font><b><%= c.SETTING%></b></font></td>
                                    <% end %>
                                  <% end %>
                                <%end %>
                                <td nowrap height="10" align=left><%= @pset %></td>
                                <!--<td nowrap height="10" align=center>
                                                 @totalper=(@tout.to_f*100)/@tin.to_f
                                                 @totalper.round
                                <% @mtrper%>%
                                                </td>-->
                                <!-- display % start-->
                                <%if @mtrper.to_i <=59%>
                                  <td nowrap height="10" align=center><font color= red><%= @mtrper %>%</font></td>
                                      <%elsif @mtrper.to_i >59 and @mtrper.to_i <=69%>
                                      <td nowrap height="10" align=center><font color= blue><%= @mtrper %>%</font></td>
                                          <%elsif @mtrper.to_i >69 and @mtrper.to_i <=80%>
                                          <td nowrap height="10" align=center><font color= green><%= @mtrper %>%</font></td>
                                              <%elsif @mtrper.to_i >80%>
                                              <td nowrap height="10" align=center><font color= red><%= @mtrper %>%</font></td>
                                                  <%end%>
                                                <!-- display % end-->
                                                </tr>

                                                <!--------------------------------------- by != M ------------------------------------------------------------------------->
                                              <% else %>
                                                <tr >
                                                  <%  machine_color  = machine_no_and_machine_name_color(@session[:shoparray1][i].to_s,c.MACHINE_NO,c.MACHINE_NAME)%>
        <%#  machine_color  = machine_no_and_machine_name_color(c.MACHINE_NO,c.MACHINE_NAME)%>
                                                  <td nowrap height="10" align=center bgcolor="<%= machine_color %>"><font color=blue><b><%= c.MACHINE_NO %></b></font></td>
                                                  <td nowrap height="10" align=center bgcolor="<%= machine_color %>"><font color=blue><b><%= c.MACHINE_NAME %></b></font></td>
                                                  <!-- display SRIN start-->
                                                  <%if c.SRIN.to_i>=0 %>
                                                    <td nowrap height="10" align=center><font color=black><%= c.SRIN.to_i %></font></td>
                                                  <%else%>
                                                    <td nowrap height="10" align=center><font color=red><%= c.SRIN.to_i %></font></td>
                                                  <%end%>
                                                  <!-- display SRIN end-->

                                                  <!-- display SROUT start-->
                                                  <%if c.SROUT.to_i>=0 %>
                                                    <td nowrap height="10" align=center><font color=black><%= c.SROUT.to_i %></font></td>
                                                  <%else%>
                                                    <td nowrap height="10" align=center><font color=red><%= c.SROUT.to_i %></font></td>
                                                  <%end%>
                                                  <!-- display SROUT end-->

                                                  <!-- display SR% start-->
                                                  <%if c.SRPER.to_i <=59%>
                                                    <td nowrap height="10" align=center><font color= red><%= c.SRPER %>%</font></td>
                                                        <%elsif c.SRPER.to_i >59 and c.SRPER.to_i <=69%>
                                                        <td nowrap height="10" align=center><font color= blue><%= c.SRPER %>%</font></td>
                                                            <%elsif c.SRPER.to_i >69 and c.SRPER.to_i <=80%>
                                                            <td nowrap height="10" align=center><font color= green><%= c.SRPER %>%</font></td>
                                                                <%elsif c.SRPER.to_i >80%>
                                                                <td nowrap height="10" align=center><font color= red><%= c.SRPER %>%</font></td>
                                                                    <%end%>
                                                                  <!-- display SR% end-->

                                                                  <!-- display TSRIN end-->
                                                                  <% if c.CALCULATEBY=='S'%>
                                                                    <% @TotalTSRIN=@TotalTSRIN.to_i+(((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round)%>
                                                                    <%@tsrinvalue=(((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round)%>
                                                                    <%if @tsrinvalue.to_i>=0 %>
                                                                      <td nowrap  height="10" align=center><font color=black><%= (((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round) %></font></td>
                                                                    <%else%>
                                                                      <td nowrap  height="10" align=center><font color=red><%= (((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round) %></font></td>
                                                                    <%end%>

                                                                    <% @TotalTSROUT=@TotalTSROUT.to_i+((c.TSROUT.to_i*c.MULTIPLY_BY*c.SCREEN_RATE_OUT.to_i)/10).round%>
                                                                    <%@tsroutvalue =(((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                                                    <%if @tsroutvalue.to_i>=0 %>
                                                                      <td nowrap  height="10" align=center><font color=black><%= (((c.TSROUT.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_OUT.to_i)/10).round) %></font></td>
                                                                    <%else%>
                                                                      <td nowrap  height="10" align=center><font color=red><%= (((c.TSROUT.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_OUT.to_i)/10).round) %></font></td>
                                                                    <%end%>

                                    <!--<td nowrap width="64" height="10" align=center><% (((c.TSROUT.to_i*c.MULTIPLY_BY*c.SCREEN_RATE_OUT.to_i)/10).round) %></td>-->
                                                                  <% else %>
                                                                    <%@tsrinsecvalue=(((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                                                    <%if @tsrinsecvalue.to_i>=0 %>
                                                                      <td nowrap  height="10" align=center><font color=black><%= (((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                                                    <%else%>
                                                                      <td nowrap  height="10" align=center><font color=red><%= (((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                                                    <%end%>

                                                                    <% @TotalTSRIN=@TotalTSRIN.to_i+(((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                                            <!--<td nowrap  height="10" align=center><%= (((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></td>-->
                                                                    <% @TotalTSROUT=@TotalTSROUT.to_i+(((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTE_RATE_OUT.to_i)/10).round)%>
                                                                    <%@tsroutsecvalue=(((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                                                    <%if @tsroutsecvalue.to_i>=0 %>
                                                                      <td nowrap  height="10" align=center><font color=black><%= (((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                                                    <%else%>
                                                                      <td nowrap  height="10" align=center><font color=red><%= (((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                                                    <%end%>

                                            <!--<td nowrap width="64" height="10" align=center><%= (((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></td>-->

                                                                  <% end %>

                                                                  <!-- display TSRIN end-->

                                                                  <!--<h2></td>ms-->
                                                                  <!-- display M/S end-->

                                                                  <%if c.MTRSHORT.to_i == 0%>
                                                                    <td nowrap height="10" align=center><font color= black><%= c.MTRSHORT.to_i %>  <%= c.SHORTREASON%></font></td>
                                                                  <%elsif c.MTRSHORT.to_i <0 %>
                                                                    <td nowrap height="10" align=center><font color= red><b><%= c.MTRSHORT.to_i %>  <%= c.SHORTREASON%></b></font></td>
                                                                  <%elsif c.MTRSHORT.to_i >0 %>
                                                                    <td nowrap height="10" align=center bgcolor=green><font color= white><b><%= c.MTRSHORT.to_i %>  <%= c.SHORTREASON%></b></font></td>
                                                                  <%end%>
                                                                  <!-- display M/S end-->


                                                                  <% @TotalMCSHORT=@TotalMCSHORT.to_i+c.MTRSHORT.to_i%>
                                                                  <% if c.CALCULATEBY=='S'%>
                                                                    <% @sr=c.SRCOLL*c.MULTIPLY_BY.to_i %>
                                                                  <% else %>
                                                                    <% @sr=c.MTRCOLL*c.MULTIPLY_BY.to_i %>
                                                                  <% end %>
                                                                  <% @TotalCOLL=@TotalCOLL.to_i+@sr.to_i %>

                                                                  <!--display Collection value start-->
                                                                  <%if @sr >=0 %>
                                                                    <td nowrap height="10" align=center><font size=3 color=blue><b><%= @sr.to_i %></b></font></td>
                                                                  <%else%>
                                                                    <td nowrap height="10" align=center><font  size=3 color=red><b><%= @sr.to_i %></b></font></td>
                                                                  <%end%>
                                                                  <!--display Collection value end-->

                                                                  <% olddate=Date.parse("#{session[:dailyvalue]}")-5%>
                                                                  <% @flagval="false" %>
                                                                  <% @totalval=0%>
                                                                  <% @mval=Machinedata.find(:first,
                                                                    :conditions=>['SHOP_NAME=? and GROUP_ID=? and MACHINE_NO=? and TRANS_DATE=?',
                                                                      @session[:shoparray1][i].to_s,key.GroupID,c.MACHINE_NO,
                                                                      session[:dailyvalue]],
                                                                    :order => "MACHINE_NAME,digitno,charno")%>
                                                                  <% @machinevalues=Machinedata.find(:all,
                                                                    :conditions=>['SHOP_NAME=? and GROUP_ID=? and MACHINE_NO=? and TRANS_DATE<=? and TRANS_DATE>=?',
                                                                      @session[:shoparray1][i].to_s,key.GroupID,c.MACHINE_NO,session[:dailyvalue],olddate+1],
                                                                    :order => "TRANS_DATE")%>
                                                                  <% @losscount=1 %>
                                                                  <%@machinevalues.each do |item|%>
                                                                    <%if ((@mval.SETTING==item.SETTING) and ((item.SRIN==item.PSRINVALUE and ((item.SRIN!=0 and item.PSRINVALUE!=0) or(item.SRIN==0 and item.PSRINVALUE==0 and item.T_DATE!=nil)))   or (item.SROUT==item.PSROUTVALUE and ((item.SROUT!=0 and item.PSROUTVALUE!=0)or(item.SROUT==0 and item.PSROUTVALUE==0 and item.T_DATE!=nil))))) %>
                                                                      <% if item.CALCULATEBY=='S'%>
                                                                        <% @srval=item.SRCOLL.to_i*c.MULTIPLY_BY.to_i %>
                                                                      <% else %>
                                                                        <% @srval=item.MTRCOLL.to_i*c.MULTIPLY_BY.to_i %>
                                                                      <% end %>

                                                                      <% if @losscount.to_i<=5%>
                                                                        <% if @srval.to_i < 0  %>
                                                                          <% @flagval="true" %>
                                                                          <% if @lossval.to_s=='0' %>
                                                                            <% @lossval="*"%>
                                                                          <% else %>
                                                                            <% @lossval=@lossval.to_s+"*"%>
                                                                          <%end%>
                                                                          <% @totalval=@totalval+@srval%>

                                                                        <% else %>
                                                                          <% if @flagval=="true" %>
                                                                            <% if @lossval.to_s=='0' %>
                                                                              <% @lossval="+"%>
                                                                            <% else %>
                                                                              <% @lossval=@lossval.to_s+"+"%>
                                                                            <%end%>
                                                                            <% @totalval=@totalval+@srval%>
                                                                          <% end %>

                                                                        <% end %>
                                                                        <% @losscount=@losscount.to_i+1%>
                                                                      <% end %>

                                                                    <% end%>

                                                                  <%end%>
                                                                  <!--display Loss  value start-->

                                                                  <% if @lossval==0%>
                                                                    <td nowrap height="10" align=left>&nbsp;</td>
                                                                  <%else%>
                                                                    <td nowrap height="10" align=left><font size=3><%= @lossval%></font></td>
                                                                  <% end %>
                                                                  <!--display Loss  value end-->
                                                                  <% @lossval=0%>
                                                                  <% @machinevalues=Machinedata.find(:all,
                                                                    :conditions=>['SHOP_NAME=? and GROUP_ID=? and MACHINE_NO=? and TRANS_DATE<=?',@session[:shoparray1][i].to_s,c.GROUP_ID,c.MACHINE_NO,session[:dailyvalue]],:order => 'TRANS_DATE desc')%>
                                                                  <%@machinevalues.each do |item|%>
                                                                    <% if c.SETTING!=item.SETTING %>
                                                                      <% @mtrper=item.MTRPER %>
                                                                      <% @pset=item.SETTING%>
                                                                      <% break%>
                                                                    <% else %>
                                                                      <% @mtrper=0 %>
                                                                      <% @pset='A'%>
                                                                    <% end %>
                                                                  <% end %>

                                                                  <!--display Loss AMT value start-->
                                                                  <%if @totalval >=0 %>
                                                                    <td nowrap height="10" align=center ><font color=black><b><%= @totalval.to_i%></b></font></td>
                                                                  <%else%>
                                                                    <td nowrap height="10" align=center ><font color=red><b><%= @totalval.to_i%></b></font></td>
                                                                  <%end%>
                                                                  <!--display Loss AMT  value end-->

                                                                  <!--display  10 avg value start-->
                                                                  <%@tenavgnew = c.TENDAYSAVG.to_i*c.MULTIPLY_BY.to_i%>
                                                                  <%if @tenavgnew >=0 %>
                                                                    <td nowrap height="10" align=center><font color=black><b><%= @tenavgnew.to_i%></b></font></td>
                                                                  <%else%>
                                                                    <td nowrap height="10" align=center><font color=red><b><%= @tenavgnew.to_i%></b></font></td>
                                                                  <%end%>
                                                                  <!--display  10 avg value end-->

                                                                  <!--display  SR avg value end-->


                                                                  <%@sravgvalue= (c.SRAVG*c.MULTIPLY_BY.to_i).round%>
                                                                  <%if @sravgvalue >=0 %>
                                                                    <td nowrap height="10" align=center><font color=black><b><%= @sravgvalue.to_i%></b></font></td>
                                                                  <%else%>
                                                                    <td nowrap height="10" align=center><font color=red><b><%= @sravgvalue.to_i%></b></font></td>
                                                                  <%end%>
                                                                  <!--display  SR avg value end-->


                                                                  <% machinesetting  = Machinedata.find_by_sql("select setting from machinedatas
          where CLUSTER_NAME='#{@session[:clustarray]}'
          and SHOP_NAME='#{@session[:shoparray1][i].to_s}'
          and machine_no='#{c.MACHINE_NO}'
          AND GROUP_ID='#{key.GroupID}'
          and TRANS_DATE<'#{session[:dailyvalue]}'
          order by TRANS_DATE desc limit 1")%>


                                                                  <% @pmper=Machinedata.find(:all,
                                                                    :conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? AND GROUP_ID=? and MACHINE_NO='#{c.MACHINE_NO}'and TRANS_DATE='#{session[:dailyvalue]}'",
                                                                      @session[:clustarray],@session[:shoparray1][i].to_s,key.GroupID],
                                                                    :order => "MACHINE_NAME,digitno,charno") %>
                                                                  <% for i1 in @pmper %>
                                                                    <%unless machinesetting[0].nil?%>
                                                                      <% if machinesetting[0].setting == i1.SETTING%>
                                                                        <td nowrap height="10" align=left><font color=blue><b><%= c.SETTING%></b></font></td>
                                                                      <% else %>
                                                                        <td nowrap height="10" align=left bgcolor="pink"><font><b><%= c.SETTING%></b></font></td>
                                                                      <% end %>
                                                                    <%end%>
                                                                  <%end %>
                                                                  <td nowrap height="10" align=left><%= @pset %></td>
                                                                  <!--<td nowrap height="10" align=center>
                                                 @totalper=(@tout.to_f*100)/@tin.to_f
                                                 @totalper.round
                                                                  <% @mtrper%>%
                                                </td>-->
                                                                  <!-- display % start-->
                                                                  <%if @mtrper.to_i <=59%>
                                                                    <td nowrap height="10" align=center><font color= red><%= @mtrper %>%</font></td>
                                                                        <%elsif @mtrper.to_i >59 and @mtrper.to_i <=69%>
                                                                        <td nowrap height="10" align=center><font color= blue><%= @mtrper %>%</font></td>
                                                                            <%elsif @mtrper.to_i >69 and @mtrper.to_i <=80%>
                                                                            <td nowrap height="10" align=center><font color= green><%= @mtrper %>%</font></td>
                                                                                <%elsif @mtrper.to_i >80%>
                                                                                <td nowrap height="10" align=center><font color= red><%= @mtrper %>%</font></td>
                                                                                    <%end%>
                                                                                  <!-- display % end-->
                                                                                  </tr>

                                                                                <%end%>
                                                                                <!----------------------------------------------- -  That_date report section ---------------------------------------------------------------------------->

                                                                              <% end %>

                                                                              <tr >
                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                <!--total TSRIN starts-->
                                                                                <%if @TotalTSRIN.to_i>=0%>
                                                                                  <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=blue><b><%= @TotalTSRIN%></b></font></td>
                                                                                <%else%>
                                                                                  <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=red><b><%= @TotalTSRIN%></b></font></td>
                                                                                <%end%>
                                                                                <!--total TSRIN end-->
                                                                                <!--total TSROUT starts-->
                                                                                <%if @TotalTSROUT.to_i>=0%>
                                                                                  <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=blue><b><%= @TotalTSROUT %></b></font></td>
                                                                                <%else%>
                                                                                  <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=red><b><%= @TotalTSROUT%></b></font></td>
                                                                                <%end%>
                                                                                <!--total TSROUT end-->

                <!--<td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3><b><% @TotalTSROUT%></b></font></td>-->
                                                                                <!--total  MCSHORT starts-->
                                                                                <%if @TotalMCSHORT.to_i>=0%>
                                                                                  <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=blue><b><%= @TotalMCSHORT %></b></font></td>

                                                                                <%else%>
                                                                                  <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=red><b><%= @TotalMCSHORT%></b></font></td>
                                                                                <%end%>
                                                                                <!--total MCSHORT end-->

                <!--<td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3><b><% @TotalMCSHORT%></b></font></td>-->
                                                                                <!--total  Coll starts-->
                                                                                <%if @TotalCOLL.to_i>=0%>
                                                                                  <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=blue><b><%= @TotalCOLL %></b></font></td>
                                                                                <%else%>
                                                                                  <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=red><b><%= @TotalCOLL%></b></font></td>
                                                                                <%end%>
                                                                                <!--total Coll end-->

                <!----<td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3><b><% @TotalCOLL%></b></font></td>-->
                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>

                                                                              </tr>
                                                                              <tr>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td><b>KEY</b></td>
    <%# @keydata=Counterdata.find(:first,:conditions=>["ClusterName in (?) and SHOP_NAME=? AND GROUP_ID=? and TRANS_DATE=?",@session[:clustarray],@session[:shoparray1][i].to_s,key.GroupID,session[:dailyvalue]],:order => "MACHINE_NAME,digitno,charno") %>
                                                                                <%@keydata= Counterdata.find(:first,:conditions=>["ClusterName in (?) and ShopName=? and Date=? ",@session[:clustarray],@session[:shoparray1][i].to_s,session[:dailyvalue]])%>
                                                                                <% if key.GroupID== 'KEY 1'%>
                                                                                  <td align=center><font size=3><b><%= @keydata.KEY1%>&nbsp;</b></font></td>
                                                                                  <% @keyd= @keydata.KEY1 %>
                                                                                <% end %>

                                                                                <% if key.GroupID== 'KEY 2'%>
                                                                                  <td align=center><font size=3><%= @keydata.KEY2%>&nbsp;</b></font></td>
                                                                                  <% @keyd= @keydata.KEY2 %>
                                                                                <% end %>

                                                                                <% if key.GroupID== 'KEY 3'%>
                                                                                  <td align=center><font size=3><%= @keydata.KEY3%>&nbsp;</b></font></td>
                                                                                  <% @keyd= @keydata.KEY3 %>
                                                                                <% end %>

                                                                                <% if key.GroupID== 'KEY 4'%>
                                                                                  <td align=center><font size=3><%= @keydata.KEY4%>&nbsp;</b></font></td>
                                                                                  <% @keyd= @keydata.KEY4 %>
                                                                                <% end %>


                                                                              </tr>

                                                                              <tr>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td></td>
                                                                                <td><b>S/E</b></td>
                                                                                <% @val= (@keyd.to_i-@TotalCOLL.to_i) %>
                                                                                <% if @val.to_i<0%>
                                                                                  <td align=center><b><font color= red size=3><%= @val %></b></font>&nbsp;</td>
                                                                          <%else%>
                                                                            <td align=center><font size=3><b><%= @val %>&nbsp;</b></td>
                                                                          <% end %>
                                                                          <%@shp=@session[:shoparray1][i].to_s%>


                                                                          </tr>
                                                                          <tr>
                                                                            <td></td>
                                                                            <td></td>
                                                                            <td></td>
                                                                            <td></td>
                                                                            <td></td>
                                                                            <td></td>
                                                                            <td></td>
                                                                            <%@mneg1=0%>
                                                                            <% @mpos1 =0 %>
                                                                            <%if @TotalMCSHORT.to_i<0 %>
                                                                              <% @mneg1= @mneg1.to_i+@TotalMCSHORT.to_i%>
                                                                            <% else %>
                                                                              <% @mpos1= @mpos1.to_i+@TotalMCSHORT.to_i%>
                                                                            <% end %>
                                                                            <% if @TotalTSRIN!=0 %>
                                                                              <% @totalper=((@TotalTSROUT.to_f-@mneg1.to_f)*100)/(@TotalTSRIN.to_f+@mpos1.to_f)%>
                                                                            <% else %>
                                                                              <% @totalper=0%>
                                                                            <% end %>
                                                                            <td><b>PERCENT</b></td>
                                                                            <td align="center"><font size="3"><%= (@totalper.to_f).round %>%</b></font></td>

                                                                          </tr>

                                                                          </table>
                                                                          <br>




                                                                          <!-- ***************************************************** M/C COUNT % & AVG ******************************* -->

                                                                          <table  border="1" width ="95%"  cellpadding="0"  cellspacing="0"  bordercolor="black"   id="AutoNumber1" >
                                                                            <% @mnamea=[]%>
                                                                            <tr bgcolor="#E7CF7C">
                                                                              <% Machinedata.find(:all,:select=>'distinct MACHINE_NAME',:conditions=>["CLUSTER_NAME in (?)
        and SHOP_NAME =?
        AND GROUP_ID=?
        and TRANS_DATE>=?
        and TRANS_DATE<=?",
                                                                                  @session[:clustarray],
                                                                                  @shp,
                                                                                  key.GroupID,
                                                                                  @session[:startdatehc],
                                                                                  session[:dailyvalue]],
                                                                                :order=>'MACHINE_NAME').each do |mdata|%>



                                                                                <%@machinecount=Machinedata.count(:conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? AND GROUP_ID=? and TRANS_DATE=?  and MACHINE_NAME=?",
                                                                                    @session[:clustarray],@shp,key.GroupID,session[:dailyvalue],mdata.MACHINE_NAME])%>
                                                                                <% @mnamea<<mdata.MACHINE_NAME %>
                                                                                <th height="20" bgcolor="#E7CF7C" ><%= mdata.MACHINE_NAME%>-<%= @machinecount %></th>
                                                                              <% end %>
                                                                            </tr>

                                                                            <tr>
                                                                              <% @counter=0 %>
                                                                              <% @ctval=0  %>
                                                                              <% for @counter in 0..(@mnamea.length-1)%>
                                                                                <% @tsrin=0 %>
                                                                                <% @tsrinvalue=0 %>
                                                                                <% @tsrout=0 %>
                                                                                <% @mtrpos=0 %>
                                                                                <% @mtrneg=0 %>
      <%# @mnamea[@counter]='ljp' %>

                                                                                <%Machinedata.find(:all,
                                                                                  :conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? AND GROUP_ID=? and TRANS_DATE<=? and TRANS_DATE>=? and MACHINE_NAME=?",
                                                                                    @session[:clustarray],@shp,key.GroupID,session[:dailyvalue],@session[:startdatehc],@mnamea[@counter]],
                                                                                  :order=>'Group_ID').each do |adata|%>

                                                                                  <% if adata.CALCULATEBY!='M'
                                                                                    @tsrin=(@tsrin+adata.TSRIN.to_i*adata.MULTIPLY_BY.to_i*adata.SCREEN_RATE_IN.to_i) %>
          <%#	@tsrout=@tsrout+adata.TSROUT.to_i %>
                                                                                    <% @tsrout=(@tsrout+adata.TSROUT.to_i*adata.MULTIPLY_BY.to_i*adata.SCREEN_RATE_OUT.to_i) %>
                                                                                  <% else %>
                                                                                    <% @tsrin=@tsrin+adata.TMTRIN.to_i*adata.MULTIPLY_BY.to_i*adata.SCREEN_RATE_IN.to_i %>
          <%# @tsrout=@tsrout+adata.TMTROUT.to_i %>
                                                                                    <% @tsrout=(@tsrout+adata.TMTROUT.to_i*adata.MULTIPLY_BY.to_i*adata.SCREEN_RATE_OUT.to_i) %>

                                                                                  <% end %>
                                                                                  <% if adata.MTRSHORT.to_i < 0 %>
                                                                                    <% @mtrneg=@mtrneg+adata.MTRSHORT.to_i %>
                                                                                  <% else
                                                                                    @mtrpos=@mtrpos+adata.MTRSHORT.to_i
                                                                                  end%>
                                                                                <% end %>

                                                                                <% @tsrin=@tsrin/10 %>
                                                                                <% @tsrout=@tsrout/10 %>

                                                                                <td align=center width="950"><B><font size="3">
                                                                                      <% if @tsrin!=0 %>
                                                                                        <span><%=  (((@tsrout.to_f-@mtrneg.to_f)*100)/(@tsrin.to_f+@mtrpos.to_f)).round%>%</span>
                                                                                        <% else %>
                                                                                          <%= 0 %>
                                                                                        <% end %>
                                                                                        <% @mnamea[@counter]%>
                                                                                        <%@machinecount=Machinedata.count(:conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? AND GROUP_ID=? and TRANS_DATE=?  and MACHINE_NAME=?",@session[:clustarray],@shp,key.GroupID,session[:dailyvalue],@mnamea[@counter]])%>

                                                                                        <% if @machinecount!=0 %>
                                                                                          <% avg = (((((@tsrin.to_f+@mtrpos.to_f)-(@tsrout.to_f-(@mtrneg.to_f)))/@machinecount)/@session[:datediff].to_i)).round %>
                                                                                        <%else%>
                                                                                          <%avg = 0%>
                                                                                        <% end %>

                                                                                        <% if avg < 0 %>
                                                                                          <span><font color=red><%= avg %></font></span>
                                                                                        <% elsif avg == 0 %>
                                                                                          <span> - </span>
                                                                                        <%else%>
                                                                                          <span><%= avg %></span>
                                                                                        <% end %>
                                                                                        </B>
                                                                                    </font>
                                                                                </td>
                                                                                <% @counter=@counter+1%>
                                                                              <% end %>
                                                                            </tr>
                                                                          </table>

                                                                          <!-- ***************************************************** M/C COUNT % & AVG ******************************* -->


                                                                          <% @total_tsrin=@total_tsrin.to_i+@TotalTSRIN.to_i%>
                                                                          <% @total_tsrout=@total_tsrout.to_i+@TotalTSROUT.to_i%>
                                                                        <%end%>

                                                                        <% shopcount=shopcount.to_i+1%>

                                                                        <BR><BR><BR><BR>
                                                                      <% end %>


                                                                      <%  if @TotalMCSHORT.to_i >= 0 %>
                                                                        <% @TOTALSHOPPER=((@total_tsrout.to_f*100)/(@total_tsrin.to_f+@TotalMCSHORT.to_i)).round %>
                                                                      <% else %>
                                                                        <% @TOTALSHOPPER=(((@total_tsrout.to_f-@TotalMCSHORT.to_i)*100)/(@total_tsrin.to_f)).round %>
                                                                      <% end %>
                                                                      <%= render :partial => 'daily_report_total_percent' ,:locals => {:shopcount => shopcount}%>
                                                                      </body>

                                                                      </html>