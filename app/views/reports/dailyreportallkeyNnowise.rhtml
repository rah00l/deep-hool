<html>
  <head>
    <meta name="GENERATOR" content="Microsoft FrontPage 5.0">
    <meta name="ProgId" content="FrontPage.Editor.Document">
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
    <title>New Page 1</title>

    <script language="JavaScript" type="text/JavaScript">
      function saveIt()
      {
        document.execCommand("SaveAs")
      }
    </script>
  </head>

  <body>
    <h2>DAILY REPORT</h2>
    <a href="javascript:saveIt()">
      Save This Page
    </a>
    <br/>

    <p align=center>
      <font size=4>
        <b>
          Date:-&nbsp;&nbsp;&nbsp;&nbsp;<%= Date.parse(session[:dailyvalue]).strftime("%d-%m-%Y") %>
        </b>
      </font>
    </p>

    <!-- Scheduler --------------------------------------------------------------------------------------------------------------------------------------->

    <table border="1" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="68%" id="AutoNumber2" height="85">
      <tr>
        <td width="34%" height="19"><font size="2">GROUP/TOT/HC</font></td>
        <td width="45%" height="19" colspan="3"><% @c= Counterdata.find_by_sql("select sum(HC) as 'totalHC' from counterdatas where  Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>
          <%= @c[0].totalHC %>
        </td>
        <!--    <td width="21%" height="19"></td> -->
      </tr>
      <tr>
        <td width="34%" height="19"><font size="2">AVG</font><font size="2">/HC-(For Per Day) </font></td>
        <td width="45%" height="19" colspan="3">
          <% if @session[:datediff].to_i!=0 %>
          <% else %>
            <% @session[:datediff]=1%>
          <% end %>

          <%= @c[0].totalHC.to_i/@session[:datediff].to_i %>

        </td>
      </tr>


      <tr>
        <td width="34%" height="19"><font size="2">TODAY'S HC</font></td>
        <td width="45%" height="19" colspan="3"><% @cc= Counterdata.find_by_sql("select sum(HC) as 'totalHC' from counterdatas where  Date='#{session[:dailyvalue]}'")%>
          <%= @cc[0].totalHC %>&nbsp;
        </td>
        <!--    <td width="21%" height="19">

        </td>-->
      </tr>
      <tr>
        <td width="34%" height="16"><font size="2">TOTAL SL/SHOP HC</font></td>
        <td width="45%" height="16" colspan="3"><% @c= Counterdata.find_by_sql("select sum(HC) as 'totalHC' from counterdatas where ClusterName='#{@session[:rrclustername]}' and ShopName in (#{@session[:shoparray]}) and Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>
          <%= @c[0].totalHC %>
        </td>
        <!-- <td width="21%" height="16"><font size="2">
    </font></td> -->
      </tr>
      <tr>
        <td width="34%" height="23"><font size="2">TODAYS SL/GROUP HC</font></td>
        <td width="45%" height="23" colspan="3"><% @c= Counterdata.find_by_sql("select sum(HC) as 'totalHC' from counterdatas where ClusterName='#{@session[:rrclustername]}' and Date='#{@session[:enddatehc]}'")%>
          <%= @c[0].totalHC %>
        </td>
        <!-- <td width="21%" height="23"></td> -->
      </tr>
      <td width="34%" height="19">&nbsp;</td>
      
      <td width="15%" height="19" align=center>HRK</td><td width="15%" height="19" align=center>LAT</td><td width="15%" height="19" align=center>MRL</td>
      <tr>
        <td width="34%" height="19"><font size="2">HC VALUES FOR ALL GROUP</font></td>
        <td width="15%" height="19" align=center><% hc = sum_of_values_for_all_group('HC','HRK',session[:startdatehc],@session[:enddatehc]) %><%= hc.blank? ? 0 : hc %></td>
        <td width="15%" height="19" align=center><% hc = sum_of_values_for_all_group('HC','LAT',session[:startdatehc],@session[:enddatehc]) %><%= hc.blank? ? 0 : hc %></td>
        <td width="15%" height="19" align=center><% hc = sum_of_values_for_all_group('HC','MRL',session[:startdatehc],@session[:enddatehc]) %><%= hc.blank? ? 0 : hc %></td>
      </tr>
      <tr>
        <td width="34%" height="19"><font size="2">HC% FOR ALL GROUP</font></td>
        <td width="15%" height="19" align=center>

          <% @c1= Counterdata.find_by_sql("select sum(HC) as 'totalHC' from counterdatas where ClusterName='HRK'  and Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>
          <% @c1[0].totalHC %>
          <% @c= Counterdata.find_by_sql("select sum(HC) as 'totalHC' from counterdatas where  Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>
          <% @c[0].totalHC %>
          <% @ctotal= @c1[0].totalHC.to_f*100/@c[0].totalHC.to_f %>

          <% if @ctotal.to_i!=0 %>
            <%= (@ctotal).round %>%
          <% else %>
            <%= 0%>
          <% end %>

        </td>
        <td width="15%" height="19" align=center>
          <% @c1= Counterdata.find_by_sql("select sum(HC) as 'totalHC' from counterdatas where ClusterName='LAT'  and Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>

          <% @c1[0].totalHC %>
          <% @c= Counterdata.find_by_sql("select sum(HC) as 'totalHC' from counterdatas where  Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>
          <% @c[0].totalHC %>
          <% @ctotal= @c1[0].totalHC.to_f*100/@c[0].totalHC.to_f %>

          <% if @ctotal.to_i!=0 %>
            <%= (@ctotal).round %>%
          <% else %>
            <%= 0%>
          <% end %>

          &nbsp;</td>
        <td width="15%" height="19" align=center>
          <% @c1= Counterdata.find_by_sql("select sum(HC) as 'totalHC' from counterdatas where ClusterName='MRL'  and Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>

          <% @c1[0].totalHC %>
          <% @c= Counterdata.find_by_sql("select sum(HC) as 'totalHC' from counterdatas where  Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>
          <% @c[0].totalHC %>
          <% @ctotal= @c1[0].totalHC.to_f*100/@c[0].totalHC.to_f %>

          <% if @ctotal.to_i!=0 %>
            <%= (@ctotal).round %>%
          <% else %>
            <%= 0%>
          <% end %>

          &nbsp;</td>
        <!-- <td width="21%" height="19" align=center>
    </td>--></tr>
    
      
      <tr>
          <td width="34%" height="19"><font size="2">EXP VALUES FOR ALL GROUP</font></td>
          <td width="15%" height="19" align=center><% exp = sum_of_values_for_all_group('EXP','HRK',session[:startdatehc],@session[:enddatehc]) %><%= exp.blank? ? 0 : exp %></td>
          <td width="15%" height="19" align=center><% exp = sum_of_values_for_all_group('EXP','LAT',session[:startdatehc],@session[:enddatehc]) %><%= exp.blank? ? 0 : exp %></td>
          <td width="15%" height="19" align=center><% exp = sum_of_values_for_all_group('EXP','MRL',session[:startdatehc],@session[:enddatehc]) %><%= exp.blank? ? 0 : exp %></td>
        </tr>
      
      <tr>
        <td width="34%" height="19"><font size="2">EXP% FOR ALL GROUP</font></td>
        <td width="15%" height="19" align=center>
          <% @c1= Counterdata.find_by_sql("select sum(Exp) as 'totalExp' from counterdatas where ClusterName='HRK'  and Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>

          <% @c1[0].totalExp %>
          <% @c= Counterdata.find_by_sql("select sum(Exp) as 'totalExp' from counterdatas where  Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>
          <% @c[0].totalExp %>
          <% @ctotal= @c1[0].totalExp.to_f*100/@c[0].totalExp.to_f %>

          <% if @ctotal.to_i!=0 %>
            <%= (@ctotal).round %>%
          <% else %>
            <%= 0%>
          <% end %>

        </td>
        <td width="15%" height="19" align=center>
          <% @c1= Counterdata.find_by_sql("select sum(Exp) as 'totalExp' from counterdatas where ClusterName='LAT'  and Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>

          <% @c1[0].totalExp %>
          <% @c= Counterdata.find_by_sql("select sum(Exp) as 'totalExp' from counterdatas where  Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>
          <% @c[0].totalExp %>
          <% @ctotal= @c1[0].totalExp.to_f*100/@c[0].totalExp.to_f %>

          <% if @ctotal.to_i!=0 %>
            <%= (@ctotal).round %>%
          <% else %>
            <%= 0%>
          <% end %>

          &nbsp;</td>
        <td width="15%" height="19" align=center>
          <% @c1= Counterdata.find_by_sql("select sum(Exp) as 'totalExp' from counterdatas where ClusterName='MRL'  and Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>

          <% @c1[0].totalExp %>
          <% @c= Counterdata.find_by_sql("select sum(Exp) as 'totalExp' from counterdatas where  Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'")%>
          <% @c[0].totalExp %>
          <% @ctotal= @c1[0].totalExp.to_f*100/@c[0].totalExp.to_f %>

          <% if @ctotal.to_i!=0 %>
            <%= (@ctotal).round %>%
          <% else %>
            <%= 0%>
          <% end %>

          &nbsp;</td>
        <!--<td width="21%" height="19">
    </td>--></tr>
      <tr>
        <td width="34%" height="19"><font size="2">TOTAL CR FOR THE MONTH</font></td>
        <td width="15%" height="19" align=center>
          <% @c=Counterdata.find_by_sql("select sum(Credit)as credit
  from counterdatas
  where ClusterName='HRK' and date='#{@session[:enddatehc]}' " )%>
          <% @c[0].credit %>

          <% @dateadj = Counterdata.find_by_sql("select DATE_SUB('#{@session[:startdatehc]}' , INTERVAL 1 DAY) as dateadj ")%>

          <% @lastmonthlastdate=@dateadj[0].dateadj%>

          <% @c1=Counterdata.find_by_sql("select sum(Credit)as credit
  from counterdatas
  where ClusterName='HRK' and date='#{@lastmonthlastdate}'")%>

          <%= @totcr4month = (@c[0].credit).to_i - (@c1[0].credit).to_i %>


        </td>

        <td width="15%" height="19" align=center>
          <% @c=Counterdata.find_by_sql("select sum(Credit)as credit
  from counterdatas
  where ClusterName='LAT' and date='#{@session[:enddatehc]}' " )%>


          <% @c1=Counterdata.find_by_sql("select sum(Credit)as credit
  from counterdatas
  where ClusterName='LAT' and date='#{@lastmonthlastdate}'")%>

          <%= @totcr4month = (@c[0].credit).to_i - (@c1[0].credit).to_i %>

          &nbsp;</td>
        <td width="15%" height="19" align=center>

          <% @c=Counterdata.find_by_sql("select sum(Credit)as credit
  from counterdatas
  where ClusterName='MRL' and date='#{@session[:enddatehc]}' " )%>


          <% @c1=Counterdata.find_by_sql("select sum(Credit)as credit
  from counterdatas
  where ClusterName='MRL' and date='#{@lastmonthlastdate}'")%>

          <%= @totcr4month = (@c[0].credit).to_i - (@c1[0].credit).to_i %>
          &nbsp;</td>
        <!--<td width="21%" height="19">
    </td>--></tr>
      <tr>
        <td width="34%" height="19"><font size="2">OUTSTANNIG FOR SHOP</font></td>
        <td width="15%" height="19" align=center>
          P
        </td>
        <td width="15%" height="19" align=center>
          P
          &nbsp;</td>
        <td width="15%" height="19" align=center>
          P
          &nbsp;</td>
        <!--<td width="21%" height="19" align=center>
    </td>-->
      </tr>
      <tr>
        <td width="34%" height="19"><font size="2">TOTAL SHOPES</font></td>
        <td width="15%" height="19" align=center>

          <%= Counterdata.count(:all,:select => 'distinct shopname',
            :conditions => "ClusterName = 'HRK' and Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}' ")%>

        </td>
        <td width="15%" height="19" align=center>

          <%= Counterdata.count(:all,:select => 'distinct shopname',
            :conditions => "ClusterName = 'LAT' and Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}' ")%>
          &nbsp;</td>
        <td width="15%" height="19" align=center>

          <%= Counterdata.count(:all,:select => 'distinct shopname',
            :conditions => "ClusterName = 'MRL' and Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}' ")%>
          &nbsp;</td>
        <!--<td width="21%" height="19">
    </td>--> </tr>

      <tr>
        <td width="34%" height="19"><font size="2">TOTAL MACHINES</font></td>

        <td width="15%" height="19" align=center><%= Machine.count(:machineno,:conditions => "clustername = 'HRK'")%>
        </td>
        <td width="15%" height="19" align=center>
          <%=  Machine.count(:machineno,:conditions => "clustername = 'LAT'")%></td>
        <td width="15%" height="19" align=center>
          <%=  Machine.count(:machineno,:conditions => "clustername = 'MRL'")%></td>
        <!--<td width="21%" height="19">
    </td>--></tr>
    </table>
    <!-- Scheduler --------------------------------------------------------------------------------------------------------------------------------------->

    <br></br>
    <%len=@session[:shoparray1].length %>
    <% total_tsrin=0%>
    <% total_tsrout=0%>
    <% shopcount=0 %>



    <%for i in 0..len-1 do %>
      <table>
        <tr>
          <td colspan=16 align=center><font size=5><b><%= @session[:shoparray1][i].to_s%></b></font></td></tr> </table>

      <!-- Shop's HC-TOT-CR-OS-M/S ------------------------------------------------------------------------------------------------>

      <% @totalREFUND1=0%>
      <% @totalBONUS1=0%>
      <% @totalADMIN1=0%>
      <% @totalCZ1=0%>
      <% @totalXYZ1=0%>
      <% @totalMF1=0%>
      <% @totalMT1=0%>
      <% @totalPF1=0%>
      <% @totalCE1=0%>
      <% @totalROK1=0%>
      <% @countvalue=0 %>
      <% @lossval=0%>

      <!-- Shop's HC-TOT-CR-OS-M/S ------------------------------------------------------------------------------------------------>
      <table border="1" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="949" id="AutoNumber3" height="33">
        <tr>
          <td bgcolor="#FFA500" width="90" height="19" ALIGN="CENTER">HCAVG</td>
          <% tar = Target.find_by_Shop_Name("#{@session[:shoparray1][i].to_s}") %>
          <td width="90" height="19"  ALIGN="CENTER"><B>
                <% hc_avg = Counterdata.average(:HC,:conditions=>["clustername=? and shopname=? and date>=? and date<=?",@session[:rrclustername],@session[:shoparray1][i].to_s,@session[:startdatehc],@session[:enddatehc]]).round %>
                <%= tar.blank? ? hc_avg : percent_font_color('',hc_avg,tar.Target_value,hc_avg,'')  %>
              </B>
            </td>

          <% data = Counterdata.find(:first,
            :conditions=>["ClusterName='#{@session[:rrclustername]}'
      and Date='#{@session[:enddatehc]}'
      and ShopName='#{@session[:shoparray1][i].to_s}'"])%>

          <td bgcolor="#FFA500" width="90" height="19" ALIGN="CENTER">HC</td>
          <td width="90" height="19" ALIGN="CENTER" ><B><%= data.HC%></B></td>

          <td bgcolor="#FFA500" width="90" height="19" ALIGN="CENTER">TARGET </td>
            <% unless tar.blank?  %>
              <td width="60" height="19" ALIGN="CENTER"><B><%= tar.Target_value %></B></td>
              <%prev_month_avg_hc = previous_month_avg_hc(@session[:rrclustername],@session[:shoparray1][i].to_s,@session[:enddatehc])%>
              <td width="50" height="19" ALIGN="CENTER"><B><%= target_percentage(prev_month_avg_hc,tar.Target_value) %></B></td>
            <%else%>
              <td width="60" height="19" ALIGN="CENTER"><span>0</span><span>0</span></td>
            <%end%>
          
          <td bgcolor="#FFA500" width="90" height="19" ALIGN="CENTER">EXPAVG</td>
          <td width="90" height="19" ALIGN="CENTER" ><B><%= Counterdata.average(:Exp,
                :conditions => ["ClusterName='#{@session[:rrclustername]}'
      and ShopName='#{@session[:shoparray1][i].to_s}'
      and Date>='#{@session[:startdatehc]}' and Date<='#{@session[:enddatehc]}'"]).to_i%>

            </B></td>

          <td bgcolor="#FFA500" width="90" height="19" ALIGN="CENTER">EXP</td>
          <td width="90" height="19" ALIGN="CENTER" ><B><%= data.Exp %>

              <td bgcolor="#FFA500" width="90" height="19" ALIGN="CENTER">CASH</td>
              <td width="90" height="19" ALIGN="CENTER" ><B><%= data.Cash %> </B></td>

        </tr></table>

      <br></br>

      <table border="1" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="949" id="AutoNumber3" height="33">
        <tr>
          <td bgcolor="#FFA500" width="50" height="19" ALIGN="CENTER">OS</td>

          <% os = Counterdata.find(:first,
            :conditions => ["ClusterName='#{@session[:rrclustername]}'
      and Date='#{@session[:enddatehc]}' and
      ShopName='#{@session[:shoparray1][i].to_s}'"])%>
          <td width="60" height="19" ALIGN="CENTER" ><B><%= os.Outstanding %></B>
          </td>
          <td bgcolor="#FFA500" width="60" height="19" ALIGN="CENTER">BAL-OS</td>
            <% bal_os = Countercollection.find_by_Date_and_ClusterName_and_ShopName(session[:dailyvalue],@session[:rrclustername],@session[:shoparray1][i].to_s)  %>
            <td width="50" height="19" ALIGN="CENTER" ><font color="red"><B><%= bal_os.blank? ? 0  : bal_os.os  %></B></font></td>

          <td bgcolor="#FFA500" width="50" height="19" ALIGN="CENTER">Y'CR</td>
          <td width="60" height="19" ALIGN="CENTER" ><B>

              <% @c1= Counterdata.find(:first,
                :conditions=>["ClusterName='#{@session[:rrclustername]}'
      and Date='#{@session[:enddatehc]-1}' and
      ShopName='#{@session[:shoparray1][i].to_s}'"])%></B>
            <% if(@c1!=nil)%>
              <% ycredit=@c1.Credit%>
            <%else%>
              <% ycredit=0%>
            <%end%>
            <B><%= ycredit%></B>
          </td>

          <td bgcolor="#FFA500" width="50" height="19" ALIGN="CENTER">T'CR</td>
          <td width="60" height="19" ALIGN="CENTER" ><B>
              <%= data.Credit%></B></td>

          <td bgcolor="#FFA500" width="50" height="19" ALIGN="CENTER">DIFF CR</td>
          <td width="60" height="19" ALIGN="CENTER" >
            <B><%= data.Credit.to_i-ycredit.to_i%></B>
          </td>
          <td bgcolor="#FFA500" width="50" height="19" ALIGN="CENTER">M/S </td>

          <% @r=Machinedata.find_by_sql("select DISTINCT TRANS_DATE from Machinedatas where CLUSTER_NAME='#{@session[:clustarray]}'
    and TRANS_DATE>='#{session[:startdatehc]}'
    and TRANS_DATE<='#{session[:enddatehc]}' and SHOP_NAME= '#{@session[:shoparray1][i].to_s}' order by TRANS_DATE") %>

          <% @r.each do |r|%>
            <% @sum=Machinedata.find_by_sql("select MTRSHORT,SHORTREASON from Machinedatas where CLUSTER_NAME='#{@session[:clustarray]}'
      and TRANS_DATE='#{r.TRANS_DATE}' and SHOP_NAME='#{@session[:shoparray1][i].to_s}'" ) %>

            <% @totalREFUND=0%>
            <% @totalBONUS=0%>
            <% @totalADMIN=0%>
            <% @totalCZ=0%>
            <% @totalXYZ=0%>
            <% @totalMF=0%>
            <% @totalMT=0%>
            <% @totalPF=0%>
            <% @totalCE=0%>
            <% @totalROK=0%>

            <% @sum.each do |s| %>

              <% if(s.SHORTREASON=="REFUND") %>
                <% @totalREFUND=@totalREFUND.to_i+s.MTRSHORT.to_i%>
                <% @totalREFUND1=@totalREFUND1.to_i+s.MTRSHORT.to_i%>
              <% end %>

              <% if(s.SHORTREASON=="BONUS") %>
                <% @totalBONUS=@totalBONUS.to_i+s.MTRSHORT.to_i%>
                <% @totalBONUS1=@totalBONUS1.to_i+s.MTRSHORT.to_i%>
              <% end %>

              <% if(s.SHORTREASON=="ADMIN") %>
                <% @totalADMIN=@totalADMIN.to_i+s.MTRSHORT.to_i%>
                <% @totalADMIN1=@totalADMIN1.to_i+s.MTRSHORT.to_i%>
              <% end %>

              <% if(s.SHORTREASON=="CZ") %>
                <% @totalCZ=@totalCZ.to_i+s.MTRSHORT.to_i%>
                <% @totalCZ1=@totalCZ1.to_i+s.MTRSHORT.to_i%>
              <% end %>

              <% if(s.SHORTREASON=="XYZ") %>
                <% @totalXYZ=@totalXYZ.to_i+s.MTRSHORT.to_i%>
                <% @totalXYZ1=@totalXYZ1.to_i+s.MTRSHORT.to_i%>
              <% end %>

              <% if(s.SHORTREASON=="MF") %>
                <% @totalMF=@totalMF.to_i+s.MTRSHORT.to_i%>
                <% @totalMF1=@totalMF1.to_i+s.MTRSHORT.to_i%>
              <% end %>

              <% if(s.SHORTREASON=="MT") %>
                <% @totalMT=@totalMT.to_i+s.MTRSHORT.to_i%>
                <% @totalMT1=@totalMT1.to_i+s.MTRSHORT.to_i%>
              <% end %>

              <% if(s.SHORTREASON=="PF") %>
                <% @totalPF=@totalPF.to_i+s.MTRSHORT.to_i%>
                <% @totalPF1=@totalPF1.to_i+s.MTRSHORT.to_i%>
              <% end %>

              <% if(s.SHORTREASON=="CE") %>
                <% @totalCE=@totalCE.to_i+s.MTRSHORT.to_i%>
                <% @totalCE1=@totalCE1.to_i+s.MTRSHORT.to_i%>
              <% end %>

              <% if(s.SHORTREASON=="ROK") %>
                <% @totalROK=@totalROK.to_i+s.MTRSHORT.to_i%>
                <% @totalROK1=@totalROK1.to_i+s.MTRSHORT.to_i%>
              <% end %>

            <%end%>

            <% @bonustotal=@totalBONUS+@totalXYZ+@totalCE %>
            <% @totalREFUND+@totalADMIN %>
            <% @MFtotal=@totalMF+@totalMT+@totalPF+@totalCZ+@totalROK %>
            <% @totalREFUND+@totalADMIN+@totalCZ+@totalBONUS+@totalXYZ+@totalMF+@totalMT+@totalPF+@totalCE+@totalROK %>

          <%end%>
          <td width="60" height="19" ALIGN="CENTER"><B><%=(@totalBONUS1.to_i+@totalCE1.to_i+@totalXYZ1.to_i)%></b></td>
          <td width="60" height="19" ALIGN="CENTER"> <b><%= @totalREFUND1.to_i+@totalADMIN1.to_i %></b></td>
          <td width="60" height="19" ALIGN="CENTER"><b><%= @totalMF1.to_i+@totalMT1.to_i+@totalPF1.to_i+@totalCZ1.to_i+@totalROK1.to_i %></b></td>

        </tr>
      </table>


      <!-- Shop's HC-TOT-CR-OS-M/S ------------------------------------------------------------------------------------------------>


  <%# @key=Group.find(:all,:conditions=>["CLUSTERNAME in (?) and SHOPNAME=?",
  @session[:clustarray],@session[:shoparray1][i].to_s],:order=>'GroupID')%>
  <%# @key.each do |key| %>

      <% @TotalTSRIN=0%>
      <% @TotalTSROUT=0%>
      <% @TotalMCSHORT=0%>
      <% @TotalCOLL=0 %>

      <% @c= Machinedata.find_by_sql("select MTRSHORT,TSRIN,TSROUT,TMTRIN,TMTROUT,SRCOLL,MTRCOLL,CALCULATEBY,SCREEN_RATE_IN,SCREEN_RATE_OUT,MTR_RATE_IN,MTE_RATE_OUT,MULTIPLY_BY
    from machinedatas
    where CLUSTER_NAME='#{@session[:rrclustername]}' and

    SHOP_NAME ='#{@session[:shoparray1][i].to_s}' and
    TRANS_DATE>='#{@session[:startdatehc]}' and TRANS_DATE<='#{@session[:enddatehc]}'
    order by digitno,charno") %>

      <% @in1=0 %>
      <% @out1=0 %>
      <% @mpos1=0%>
      <% @mneg1=0%>
      <%for c in @c %>
        <% if(c.CALCULATEBY=='S')%>
          <% @in1=@in1.to_i+((c.TSRIN.to_i*c.SCREEN_RATE_IN.to_i*c.MULTIPLY_BY)/10).round%>
          <% @out1=@out1.to_i+((c.TSROUT.to_i*c.SCREEN_RATE_OUT.to_i*c.MULTIPLY_BY)/10).round%>
        <% else%>
          <% @in1=@in1.to_i+((c.TMTRIN.to_i*c.MTR_RATE_IN.to_i*c.MULTIPLY_BY)/10).round%>
          <% @out1=@out1.to_i+((c.TMTROUT.to_i*c.MTE_RATE_OUT.to_i*c.MULTIPLY_BY)/10).round%>
        <%end%>

        <%if c.MTRSHORT.to_i<0 %>
          <% @mneg1=@mneg1.to_i+c.MTRSHORT.to_i%>
        <% else %>
          <% @mpos1=@mpos1.to_i+c.MTRSHORT.to_i%>
        <% end %>
      <% end %>

      <% if @in1!=0 %>
        <% @totalper=((@out1.to_i-@mneg1.to_i)*100)/(@in1.to_i-@mpos1.to_i)%>
      <% else %>
        <% @totalper=0%>
      <% end %>
      <% @totalper.round %>
      <BR>

  <%@totalamt=@totalper.round%>
          
            <table>
              <tr><td colspan=16><font size=4>
                    <b><span>&nbsp;&nbsp;S/E&nbsp;&nbsp;<% ShortExtra.find(:all,:select=>'group_id',:conditions => ["date=? and cluster_name=? and shop_name=? ",session[:dailyvalue],@session[:rrclustername],@session[:shoparray1][i].to_s]).each do |key| %>
                        <% short_extra = short_extra_values(@session[:startdatehc],@session[:enddatehc],@session[:rrclustername],@session[:shoparray1][i].to_s,key.group_id) %>
                                <%= key.group_id %>&nbsp;&nbsp;
                                <%= se_value = short_extra.blank? ? '' : font_color(short_extra)  %>&nbsp;&nbsp;</span>
                          <%end%>
                      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                      <span><%= @session[:shoparray1][i].to_s%></span>&nbsp;&nbsp;
                      <%= tot_percentage_color(@totalamt) %></b></td>
              </tr>
            </table>
                      <br></br>

                      <table  border="1" width ="95%"  cellpadding="0"  cellspacing="0"  bordercolor="black"   id="AutoNumber1" >

                        <tr >
                          <th scope=col nowrap width="4%"  height="20">NO</th>
                          <th scope=col width="6%" height="1"  >NAME</th>
                          <th scope=col nowrap width="7%" height="1"  >SRIN</th>
                          <th scope=col nowrap width="7%" height="1"  >SROUT</th>
                          <th scope=col nowrap width="5%" height="1"  >SR %</th>
                          <th scope=col nowrap width="7%" height="1"  >TSRIN</th>
                          <th scope=col nowrap width="7%" height="1"  >TSROUT</th>
                          <th scope=col nowrap width="7%" height="1"  >M/S</th>
                          <th scope=col nowrap width="7%" height="1"  >COLL</th>
                          <th scope=col nowrap width="7%" height="1"  >T SET</th>
                          <th scope=col nowrap width="7%" height="1"  >P SET</th>
                          <th scope=col nowrap width="7%" height="1"  >PM %</th>
                          <th scope=col nowrap width="5%" height="1"  >LOSS</th>
                          <th scope=col nowrap width="7%" height="1"  >LOSS</th>
                          <th scope=col nowrap width="7%" height="1"  >10 AVG</th>
                          <th scope=col nowrap width="6%" height="1"  >SR AVG</th>


                        </tr>
                        <% @machinesdata=Machinedata.find(:all,
                          :conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? and TRANS_DATE=?",
                            @session[:clustarray],@session[:shoparray1][i].to_s,session[:dailyvalue]],
                          :order => "digitno,charno") %>
                        <% @machinesdata.each do |c| %>
                          <% @pmper=Machinedata.find(:all,
                            :conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? and MACHINE_NO='#{c.MACHINE_NO}'",
                              @session[:clustarray],@session[:shoparray1][i].to_s],
                            :order => "digitno,charno") %>
                          <% @tin=0%>
                          <% @tout=0%>
                          <% @coll=0%>
                          <% for i1 in @pmper %>
                            <%if(i1.CALCULATEBY=='S')%>
                              <%@tin=@tin.to_i+i1.TSRIN.to_i%>
                              <%@tout=@tout.to_i+i1.TSROUT.to_i%>
                            <%else%>
                              <%@tin=@tin.to_i+i1.TMTRIN.to_i%>
                              <%@tout=@tout.to_i+i1.TMTROUT.to_i%>
                            <%end%>
                          <% end %>

                          <!----------------------------------------------- ----------------------------------------------------------------------------->

                          <% if c.CALCULATEBY == 'M'%>

                            <tr bgcolor="#FFA500">

                              <td nowrap height="10" align=center><font color=blue><b><%= c.MACHINE_NO %></b></font></td>
                              <td nowrap height="10" align=center><font color=blue><b><%= c.MACHINE_NAME %></b></font></td>
                              <!-- display SRIN start-->
                              <%if c.SRIN.to_i>=0 %>
                                <td nowrap height="10" align=center><font color=black><%= c.SRIN.to_i %></font></td>
                              <%else%>
                                <td nowrap height="10" align=center><font color=red><%= c.SRIN.to_i %></font></td>
                              <%end%>
                              <!-- display SRIN end-->

                              <!-- display SROUT start-->
                              <%if c.SROUT.to_i>=0 %>
                                <td nowrap height="10" align=center><font color=black><%= c.SROUT.to_i %></font></td>
                              <%else%>
                                <td nowrap height="10" align=center><font color=red><%= c.SROUT.to_i %></font></td>
                              <%end%>
                              <!-- display SROUT end-->

                              <!-- display SR% start-->
                              <%if c.SRPER.to_i <=59%>
                                <td nowrap height="10" align=center><font color= red><%= c.SRPER %>%</font></td>
                                    <%elsif c.SRPER.to_i >59 and c.SRPER.to_i <=69%>
                                    <td nowrap height="10" align=center><font color= blue><%= c.SRPER %>%</font></td>
                                        <%elsif c.SRPER.to_i >69 and c.SRPER.to_i <=80%>
                                        <td nowrap height="10" align=center><font color= green><%= c.SRPER %>%</font></td>
                                            <%elsif c.SRPER.to_i >80%>
                                            <td nowrap height="10" align=center><font color= red><%= c.SRPER %>%</font></td>
                                                <%end%>
                                              <!-- display SR% end-->
                                              <!-- display TSRIN end-->

                                              <% if c.CALCULATEBY=='S'%>
                                                <% @TotalTSRIN=@TotalTSRIN.to_i+(((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round)%>
                                                <%@tsrinvalue=(((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round)%>
                                                <%if @tsrinvalue.to_i>=0 %>
                                                  <td nowrap  height="10" align=center><font color=black><%= (((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round) %></font></td>
                                                <%else%>
                                                  <td nowrap  height="10" align=center><font color=red><%= (((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round) %></font></td>
                                                <%end%>

                                                <% @TotalTSROUT=@TotalTSROUT.to_i+((c.TSROUT.to_i*c.MULTIPLY_BY*c.SCREEN_RATE_OUT.to_i)/10).round%>
                                                <%@tsroutvalue =(((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                                <%if @tsroutvalue.to_i>=0 %>
                                                  <td nowrap  height="10" align=center><font color=black><%= (((c.TSROUT.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_OUT.to_i)/10).round) %></font></td>
                                                <%else%>
                                                  <td nowrap  height="10" align=center><font color=red><%= (((c.TSROUT.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_OUT.to_i)/10).round) %></font></td>
                                                <%end%>

                        <!--<td nowrap width="64" height="10" align=center><% (((c.TSROUT.to_i*c.MULTIPLY_BY*c.SCREEN_RATE_OUT.to_i)/10).round) %></td>-->
                                              <% else %>
                                                <%@tsrinsecvalue=(((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                                <%if @tsrinsecvalue.to_i>=0 %>
                                                  <td nowrap  height="10" align=center><font color=black><%= (((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                                <%else%>
                                                  <td nowrap  height="10" align=center><font color=red><%= (((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                                <%end%>

                                                <% @TotalTSRIN=@TotalTSRIN.to_i+(((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                                <!--<td nowrap  height="10" align=center><%= (((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></td>-->
                                                <% @TotalTSROUT=@TotalTSROUT.to_i+(((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTE_RATE_OUT.to_i)/10).round)%>
                                                <%@tsroutsecvalue=(((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                                <%if @tsroutsecvalue.to_i>=0 %>
                                                  <td nowrap  height="10" align=center><font color=black><%= (((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                                <%else%>
                                                  <td nowrap  height="10" align=center><font color=red><%= (((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                                <%end%>

                                <!--<td nowrap width="64" height="10" align=center><%= (((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></td>-->

                                              <% end %>

                                              <!-- display TSRIN end-->

                                              <!--<h2></td>ms-->
                                              <!-- display M/S end-->

                                              <%if c.MTRSHORT.to_i == 0%>
                                                <td nowrap height="10" align=center><font color= black><%= c.MTRSHORT.to_i %>  <%= c.SHORTREASON%></font></td>
                                              <%elsif c.MTRSHORT.to_i <0 %>
                                                <td nowrap height="10" align=center><font color= red><b><%= c.MTRSHORT.to_i %>  <%= c.SHORTREASON%></b></font></td>
                                              <%elsif c.MTRSHORT.to_i >0 %>
                                                <td nowrap height="10" align=center bgcolor=green><font color= white><b><%= c.MTRSHORT.to_i %>  <%= c.SHORTREASON%></b></font></td>
                                              <%end%>
                                              <!-- display M/S end-->


                                              <% @TotalMCSHORT=@TotalMCSHORT.to_i+c.MTRSHORT.to_i%>
                                              <% if c.CALCULATEBY=='S'%>
                                                <% @sr=c.SRCOLL*c.MULTIPLY_BY.to_i %>
                                              <% else %>
                                                <% @sr=c.MTRCOLL*c.MULTIPLY_BY.to_i %>
                                              <% end %>
                                              <% @TotalCOLL=@TotalCOLL.to_i+@sr.to_i %>

                                              <!--display Collection value start-->
                                              <%if @sr >=0 %>
                                                <td nowrap height="10" align=center><font size=3 color=blue><b><%= @sr.to_i %></b></font></td>
                                              <%else%>
                                                <td nowrap height="10" align=center><font  size=3 color=red><b><%= @sr.to_i %></b></font></td>
                                              <%end%>
                                              <!--display Collection value end-->



                                              <% machinesetting  = Machinedata.find_by_sql("select setting from Machinedatas
        where CLUSTER_NAME='#{@session[:clustarray]}'
        and SHOP_NAME='#{@session[:shoparray1][i].to_s}'
        and machine_no='#{c.MACHINE_NO}'
        and TRANS_DATE<'#{session[:dailyvalue]}'
        order by TRANS_DATE desc limit 1")%>


                                              <% @pmper=Machinedata.find(:all,
                                                :conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? and MACHINE_NO='#{c.MACHINE_NO}'and TRANS_DATE='#{session[:dailyvalue]}'",
                                                  @session[:clustarray],@session[:shoparray1][i].to_s],
                                                :order => "MACHINE_NAME,digitno,charno") %>
                                              <% for i1 in @pmper %>
                                                <%unless machinesetting[0].nil?%>
                                                <% if machinesetting[0].setting == i1.SETTING%>
                                                  <td nowrap height="10" align=left><font color=blue><b><%= c.SETTING%></b></font></td>
                                                <% else %>
                                                  <td nowrap height="10" align=left bgcolor="pink"><font><b><%= c.SETTING%></b></font></td>
                                                <% end %>
                                                <% end %>
                                              <%end %>

                                              <% @lossval=0%>
                                              <% @machinevalues=Machinedata.find(:all,:conditions=>['SHOP_NAME=?  and MACHINE_NO=? and TRANS_DATE<=?',@session[:shoparray1][i].to_s,c.MACHINE_NO,session[:dailyvalue]],:order => 'TRANS_DATE desc')%>
                                              <%@machinevalues.each do |item|%>
                                                <% if c.SETTING!=item.SETTING %>
                                                  <% @mtrper=item.MTRPER %>
                                                  <% @pset=item.SETTING%>
                                                  <% break%>
                                                <% else %>
                                                  <% @mtrper=0 %>
                                                  <% @pset='A'%>
                                                <% end %>
                                              <% end %>

                                              <td nowrap height="10" align=left><%= @pset %></td>
                                              <!--<td nowrap height="10" align=center>
                                                               @totalper=(@tout.to_f*100)/@tin.to_f
                                                               @totalper.round
                                              <% @mtrper%>%
                                                              </td>-->
                                              <!-- display % start-->
                                              <%if @mtrper.to_i <=59%>
                                                <td nowrap height="10" align=center><font color= red><%= @mtrper %>%</font></td>
                                                    <%elsif @mtrper.to_i >59 and @mtrper.to_i <=69%>
                                                    <td nowrap height="10" align=center><font color= blue><%= @mtrper %>%</font></td>
                                                        <%elsif @mtrper.to_i >69 and @mtrper.to_i <=80%>
                                                        <td nowrap height="10" align=center><font color= green><%= @mtrper %>%</font></td>
                                                            <%elsif @mtrper.to_i >80%>
                                                            <td nowrap height="10" align=center><font color= red><%= @mtrper %>%</font></td>
                                                                <%end%>
                                                              <!-- display % end-->


                                                              <% olddate=Date.parse("#{session[:dailyvalue]}")-5%>
                                                              <% @flagval="false" %>
                                                              <% @totalval=0%>
                                                              <% @mval=Machinedata.find(:first,
                                                                :conditions=>['SHOP_NAME=? and  MACHINE_NO=? and TRANS_DATE=?',
                                                                  @session[:shoparray1][i].to_s,c.MACHINE_NO,
                                                                  session[:dailyvalue]],
                                                                :order => "MACHINE_NAME,digitno,charno")%>
                                                              <% puts olddate%>
                                                              <% @machinevalues=Machinedata.find(:all,
                                                                :conditions=>['SHOP_NAME=? and MACHINE_NO=? and TRANS_DATE<=? and TRANS_DATE>=?',
                                                                  @session[:shoparray1][i].to_s,c.MACHINE_NO,session[:dailyvalue],olddate+1],
                                                                :order => "TRANS_DATE")%>
                                                              <% @losscount=1 %>
                                                              <%@machinevalues.each do |item|%>
                                                                <%if ((@mval.SETTING==item.SETTING) and ((item.SRIN==item.PSRINVALUE and ((item.SRIN!=0 and item.PSRINVALUE!=0) or(item.SRIN==0 and item.PSRINVALUE==0 and item.T_DATE!=nil)))   or (item.SROUT==item.PSROUTVALUE and ((item.SROUT!=0 and item.PSROUTVALUE!=0)or(item.SROUT==0 and item.PSROUTVALUE==0 and item.T_DATE!=nil))))) %>
                                                                  <% if item.CALCULATEBY=='S'%>
                                                                    <% @srval=item.SRCOLL.to_i*c.MULTIPLY_BY.to_i %>
                                                                  <% else %>
                                                                    <% @srval=item.MTRCOLL.to_i*c.MULTIPLY_BY.to_i %>
                                                                  <% end %>

                                                                  <% if @losscount.to_i<=5%>
                                                                    <% if @srval.to_i < 0  %>
                                                                      <% @flagval="true" %>
                                                                      <% if @lossval.to_s=='0' %>
                                                                        <% @lossval="*"%>
                                                                      <% else %>
                                                                        <% @lossval=@lossval.to_s+"*"%>
                                                                      <%end%>
                                                                      <% @totalval=@totalval+@srval%>

                                                                    <% else %>
                                                                      <% if @flagval=="true" %>
                                                                        <% if @lossval.to_s=='0' %>
                                                                          <% @lossval="+"%>
                                                                        <% else %>
                                                                          <% @lossval=@lossval.to_s+"+"%>
                                                                        <%end%>
                                                                        <% @totalval=@totalval+@srval%>
                                                                      <% end %>

                                                                    <% end %>
                                                                    <% @losscount=@losscount.to_i+1%>
                                                                  <% end %>

                                                                <% end%>

                                                              <%end%>
                                                              <!--display Loss  value start-->

                                                              <% if @lossval==0%>
                                                                <td nowrap height="10" align=left>&nbsp;</td>
                                                              <%else%>
                                                                <td nowrap height="10" align=left><font size=3><%= @lossval%></font></td>
                                                              <% end %>
                                                              <!--display Loss  value end-->

                                                              <!--display Loss AMT value start-->
                                                              <%if @totalval >=0 %>
                                                                <td nowrap height="10" align=center ><font color=black><b><%= @totalval.to_i%></b></font></td>
                                                              <%else%>
                                                                <td nowrap height="10" align=center ><font color=red><b><%= @totalval.to_i%></b></font></td>
                                                              <%end%>
                                                              <!--display Loss AMT  value end-->

                                                              <!--display  10 avg value start-->
                                                              <%@tenavgnew = c.TENDAYSAVG.to_i*c.MULTIPLY_BY.to_i%>
                                                              <%if @tenavgnew >=0 %>
                                                                <td nowrap height="10" align=center><font color=black><b><%= @tenavgnew.to_i%></b></font></td>
                                                              <%else%>
                                                                <td nowrap height="10" align=center><font color=red><b><%= @tenavgnew.to_i%></b></font></td>
                                                              <%end%>
                                                              <!--display  10 avg value end-->

                                                              <!--display  SR avg value end-->
                                                              <%@sravgvalue= (c.SRAVG*c.MULTIPLY_BY.to_i).round%>
                                                              <%if @sravgvalue >=0 %>
                                                                <td nowrap height="10" align=center><font color=black><b><%= @sravgvalue.to_i%></b></font></td>
                                                              <%else%>
                                                                <td nowrap height="10" align=center><font color=red><b><%= @sravgvalue.to_i%></b></font></td>
                                                              <%end%>
                                                              <!--display  SR avg value end-->

                                                              </tr>

                                                              <!--------------------------------------- by != M ------------------------------------------------------------------------->
                                                            <% else %>
                                                              <tr >

                                                                <td nowrap height="10" align=center><font color=blue><b><%= c.MACHINE_NO %></b></font></td>
                                                                <td nowrap height="10" align=center><font color=blue><b><%= c.MACHINE_NAME %></b></font></td>
                                                                <!-- display SRIN start-->
                                                                <%if c.SRIN.to_i>=0 %>
                                                                  <td nowrap height="10" align=center><font color=black><%= c.SRIN.to_i %></font></td>
                                                                <%else%>
                                                                  <td nowrap height="10" align=center><font color=red><%= c.SRIN.to_i %></font></td>
                                                                <%end%>
                                                                <!-- display SRIN end-->

                                                                <!-- display SROUT start-->
                                                                <%if c.SROUT.to_i>=0 %>
                                                                  <td nowrap height="10" align=center><font color=black><%= c.SROUT.to_i %></font></td>
                                                                <%else%>
                                                                  <td nowrap height="10" align=center><font color=red><%= c.SROUT.to_i %></font></td>
                                                                <%end%>
                                                                <!-- display SROUT end-->

                                                                <!-- display SR% start-->
                                                                <%if c.SRPER.to_i <=59%>
                                                                  <td nowrap height="10" align=center><font color= red><%= c.SRPER %>%</font></td>
                                                                      <%elsif c.SRPER.to_i >59 and c.SRPER.to_i <=69%>
                                                                      <td nowrap height="10" align=center><font color= blue><%= c.SRPER %>%</font></td>
                                                                          <%elsif c.SRPER.to_i >69 and c.SRPER.to_i <=80%>
                                                                          <td nowrap height="10" align=center><font color= green><%= c.SRPER %>%</font></td>
                                                                              <%elsif c.SRPER.to_i >80%>
                                                                              <td nowrap height="10" align=center><font color= red><%= c.SRPER %>%</font></td>
                                                                                  <%end%>
                                                                                <!-- display SR% end-->

                                                                                <!-- display TSRIN end-->
                                                                                <% if c.CALCULATEBY=='S'%>
                                                                                  <% @TotalTSRIN=@TotalTSRIN.to_i+(((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round)%>
                                                                                  <%@tsrinvalue=(((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round)%>
                                                                                  <%if @tsrinvalue.to_i>=0 %>
                                                                                    <td nowrap  height="10" align=center><font color=black><%= (((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round) %></font></td>
                                                                                  <%else%>
                                                                                    <td nowrap  height="10" align=center><font color=red><%= (((c.TSRIN.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_IN.to_i)/10).round) %></font></td>
                                                                                  <%end%>

                                                                                  <% @TotalTSROUT=@TotalTSROUT.to_i+((c.TSROUT.to_i*c.MULTIPLY_BY*c.SCREEN_RATE_OUT.to_i)/10).round%>
                                                                                  <%@tsroutvalue =(((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                                                                  <%if @tsroutvalue.to_i>=0 %>
                                                                                    <td nowrap  height="10" align=center><font color=black><%= (((c.TSROUT.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_OUT.to_i)/10).round) %></font></td>
                                                                                  <%else%>
                                                                                    <td nowrap  height="10" align=center><font color=red><%= (((c.TSROUT.to_i*c.MULTIPLY_BY.to_i*c.SCREEN_RATE_OUT.to_i)/10).round) %></font></td>
                                                                                  <%end%>

                        <!--<td nowrap width="64" height="10" align=center><% (((c.TSROUT.to_i*c.MULTIPLY_BY*c.SCREEN_RATE_OUT.to_i)/10).round) %></td>-->
                                                                                <% else %>
                                                                                  <%@tsrinsecvalue=(((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                                                                  <%if @tsrinsecvalue.to_i>=0 %>
                                                                                    <td nowrap  height="10" align=center><font color=black><%= (((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                                                                  <%else%>
                                                                                    <td nowrap  height="10" align=center><font color=red><%= (((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                                                                  <%end%>

                                                                                  <% @TotalTSRIN=@TotalTSRIN.to_i+(((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                                <!--<td nowrap  height="10" align=center><%= (((c.TMTRIN.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></td>-->
                                                                                  <% @TotalTSROUT=@TotalTSROUT.to_i+(((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTE_RATE_OUT.to_i)/10).round)%>
                                                                                  <%@tsroutsecvalue=(((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round)%>
                                                                                  <%if @tsroutsecvalue.to_i>=0 %>
                                                                                    <td nowrap  height="10" align=center><font color=black><%= (((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                                                                  <%else%>
                                                                                    <td nowrap  height="10" align=center><font color=red><%= (((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></font></td>
                                                                                  <%end%>

                                <!--<td nowrap width="64" height="10" align=center><%= (((c.TMTROUT.to_i*c.MULTIPLY_BY*c.MTR_RATE_IN.to_i)/10).round) %></td>-->

                                                                                <% end %>

                                                                                <!-- display TSRIN end-->

                                                                                <!--<h2></td>ms-->
                                                                                <!-- display M/S end-->

                                                                                <%if c.MTRSHORT.to_i == 0%>
                                                                                  <td nowrap height="10" align=center><font color= black><%= c.MTRSHORT.to_i %>  <%= c.SHORTREASON%></font></td>
                                                                                <%elsif c.MTRSHORT.to_i <0 %>
                                                                                  <td nowrap height="10" align=center><font color= red><b><%= c.MTRSHORT.to_i %>  <%= c.SHORTREASON%></b></font></td>
                                                                                <%elsif c.MTRSHORT.to_i >0 %>
                                                                                  <td nowrap height="10" align=center bgcolor=green><font color= white><b><%= c.MTRSHORT.to_i %>  <%= c.SHORTREASON%></b></font></td>
                                                                                <%end%>
                                                                                <!-- display M/S end-->


                                                                                <% @TotalMCSHORT=@TotalMCSHORT.to_i+c.MTRSHORT.to_i%>
                                                                                <% if c.CALCULATEBY=='S'%>
                                                                                  <% @sr=c.SRCOLL*c.MULTIPLY_BY.to_i %>
                                                                                <% else %>
                                                                                  <% @sr=c.MTRCOLL*c.MULTIPLY_BY.to_i %>
                                                                                <% end %>
                                                                                <% @TotalCOLL=@TotalCOLL.to_i+@sr.to_i %>

                                                                                <!--display Collection value start-->
                                                                                <%if @sr >=0 %>
                                                                                  <td nowrap height="10" align=center><font size=3 color=blue><b><%= @sr.to_i %></b></font></td>
                                                                                <%else%>
                                                                                  <td nowrap height="10" align=center><font  size=3 color=red><b><%= @sr.to_i %></b></font></td>
                                                                                <%end%>
                                                                                <!--display Collection value end-->

                                                                                <% machinesetting  = Machinedata.find_by_sql("select setting from Machinedatas
        where CLUSTER_NAME='#{@session[:clustarray]}'
        and SHOP_NAME='#{@session[:shoparray1][i].to_s}'
        and machine_no='#{c.MACHINE_NO}'
        and TRANS_DATE<'#{session[:dailyvalue]}'
        order by TRANS_DATE desc limit 1")%>
                                                                                <% @pmper=Machinedata.find(:all,
                                                                                  :conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? and MACHINE_NO='#{c.MACHINE_NO}'and TRANS_DATE='#{session[:dailyvalue]}'",
                                                                                    @session[:clustarray],@session[:shoparray1][i].to_s],
                                                                                  :order => "MACHINE_NAME,digitno,charno") %>
                                                                                <% for i1 in @pmper %>
                                                                                <%unless machinesetting[0].nil?%>
                                                                                  <% if machinesetting[0].setting == i1.SETTING%>
                                                                                    <td nowrap height="10" align=left><font color=blue><b><%= c.SETTING%></b></font></td>
                                                                                  <% else %>
                                                                                    <td nowrap height="10" align=left bgcolor="pink"><font><b><%= c.SETTING%></b></font></td>
                                                                                  <% end %>
                                                                                  <% end %>
                                                                                <%end %>



                                                                                <% @lossval=0%>
                                                                                <% @machinevalues=Machinedata.find(:all,
                                                                                  :conditions=>['SHOP_NAME=? and MACHINE_NO=? and TRANS_DATE<=?',@session[:shoparray1][i].to_s,c.MACHINE_NO,session[:dailyvalue]],:order => 'TRANS_DATE desc')%>
                                                                                <%@machinevalues.each do |item|%>
                                                                                  <% if c.SETTING!=item.SETTING %>
                                                                                    <% @mtrper=item.MTRPER %>
                                                                                    <% @pset=item.SETTING%>
                                                                                    <% break%>
                                                                                  <% else %>
                                                                                    <% @mtrper=0 %>
                                                                                    <% @pset='A'%>
                                                                                  <% end %>
                                                                                <% end %>


                                                                                <td nowrap height="10" align=left><%= @pset %></td>
                                                                                <!--<td nowrap height="10" align=center>
                                                               @totalper=(@tout.to_f*100)/@tin.to_f
                                                               @totalper.round
                                                                                <% @mtrper%>%
                                                              </td>-->
                                                                                <!-- display % start-->
                                                                                <%if @mtrper.to_i <=59%>
                                                                                  <td nowrap height="10" align=center><font color= red><%= @mtrper %>%</font></td>
                                                                                      <%elsif @mtrper.to_i >59 and @mtrper.to_i <=69%>
                                                                                      <td nowrap height="10" align=center><font color= blue><%= @mtrper %>%</font></td>
                                                                                          <%elsif @mtrper.to_i >69 and @mtrper.to_i <=80%>
                                                                                          <td nowrap height="10" align=center><font color= green><%= @mtrper %>%</font></td>
                                                                                              <%elsif @mtrper.to_i >80%>
                                                                                              <td nowrap height="10" align=center><font color= red><%= @mtrper %>%</font></td>
                                                                                                  <%end%>
                                                                                                <!-- display % end-->





                                                                                                <% olddate=Date.parse("#{session[:dailyvalue]}")-5%>
                                                                                                <% @flagval="false" %>
                                                                                                <% @totalval=0%>
                                                                                                <% @mval=Machinedata.find(:first,
                                                                                                  :conditions=>['SHOP_NAME=? and MACHINE_NO=? and TRANS_DATE=?',
                                                                                                    @session[:shoparray1][i].to_s,c.MACHINE_NO,
                                                                                                    session[:dailyvalue]],
                                                                                                  :order => "MACHINE_NAME,digitno,charno")%>
                                                                                                <% #puts olddate%>
                                                                                                <% @machinevalues=Machinedata.find(:all,
                                                                                                  :conditions=>['SHOP_NAME=? and MACHINE_NO=? and TRANS_DATE<=? and TRANS_DATE>=?',
                                                                                                    @session[:shoparray1][i].to_s,c.MACHINE_NO,session[:dailyvalue],olddate+1],
                                                                                                  :order => "TRANS_DATE")%>
                                                                                                <% @losscount=1 %>
                                                                                                <%@machinevalues.each do |item|%>
                                                                                                  <%if ((@mval.SETTING==item.SETTING) and ((item.SRIN==item.PSRINVALUE and ((item.SRIN!=0 and item.PSRINVALUE!=0) or(item.SRIN==0 and item.PSRINVALUE==0 and item.T_DATE!=nil)))   or (item.SROUT==item.PSROUTVALUE and ((item.SROUT!=0 and item.PSROUTVALUE!=0)or(item.SROUT==0 and item.PSROUTVALUE==0 and item.T_DATE!=nil))))) %>
                                                                                                    <% if item.CALCULATEBY=='S'%>
                                                                                                      <% @srval=item.SRCOLL.to_i*c.MULTIPLY_BY.to_i %>
                                                                                                    <% else %>
                                                                                                      <% @srval=item.MTRCOLL.to_i*c.MULTIPLY_BY.to_i %>
                                                                                                    <% end %>

                                                                                                    <% if @losscount.to_i<=5%>
                                                                                                      <% if @srval.to_i < 0  %>
                                                                                                        <% @flagval="true" %>
                                                                                                        <% if @lossval.to_s=='0' %>
                                                                                                          <% @lossval="*"%>
                                                                                                        <% else %>
                                                                                                          <% @lossval=@lossval.to_s+"*"%>
                                                                                                        <%end%>
                                                                                                        <% @totalval=@totalval+@srval%>

                                                                                                      <% else %>
                                                                                                        <% if @flagval=="true" %>
                                                                                                          <% if @lossval.to_s=='0' %>
                                                                                                            <% @lossval="+"%>
                                                                                                          <% else %>
                                                                                                            <% @lossval=@lossval.to_s+"+"%>
                                                                                                          <%end%>
                                                                                                          <% @totalval=@totalval+@srval%>
                                                                                                        <% end %>

                                                                                                      <% end %>
                                                                                                      <% @losscount=@losscount.to_i+1%>
                                                                                                    <% end %>

                                                                                                  <% end%>

                                                                                                <%end%>
                                                                                                <!--display Loss  value start-->

                                                                                                <% if @lossval==0%>
                                                                                                  <td nowrap height="10" align=left>&nbsp;</td>
                                                                                                <%else%>
                                                                                                  <td nowrap height="10" align=left><font size=3><%= @lossval%></font></td>
                                                                                                <% end %>
                                                                                                <!--display Loss  value end-->

                                                                                                <!--display Loss AMT value start-->
                                                                                                <%if @totalval >=0 %>
                                                                                                  <td nowrap height="10" align=center ><font color=black><b><%= @totalval.to_i%></b></font></td>
                                                                                                <%else%>
                                                                                                  <td nowrap height="10" align=center ><font color=red><b><%= @totalval.to_i%></b></font></td>
                                                                                                <%end%>
                                                                                                <!--display Loss AMT  value end-->

                                                                                                <!--display  10 avg value start-->
                                                                                                <%@tenavgnew = c.TENDAYSAVG.to_i*c.MULTIPLY_BY.to_i%>
                                                                                                <%if @tenavgnew >=0 %>
                                                                                                  <td nowrap height="10" align=center><font color=black><b><%= @tenavgnew.to_i%></b></font></td>
                                                                                                <%else%>
                                                                                                  <td nowrap height="10" align=center><font color=red><b><%= @tenavgnew.to_i%></b></font></td>
                                                                                                <%end%>
                                                                                                <!--display  10 avg value end-->

                                                                                                <!--display  SR avg value end-->


                                                                                                <%@sravgvalue= (c.SRAVG*c.MULTIPLY_BY.to_i).round%>
                                                                                                <%if @sravgvalue >=0 %>
                                                                                                  <td nowrap height="10" align=center><font color=black><b><%= @sravgvalue.to_i%></b></font></td>
                                                                                                <%else%>
                                                                                                  <td nowrap height="10" align=center><font color=red><b><%= @sravgvalue.to_i%></b></font></td>
                                                                                                <%end%>
                                                                                                <!--display  SR avg value end-->


                                                                                                </tr>

                                                                                              <%end%>
                                                                                              <!----------------------------------------------- -  That_date report section ---------------------------------------------------------------------------->

                                                                                            <% end %>

                                                                                            <tr >
                                                                                              <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                              <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                              <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                              <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                              <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                              <!--total TSRIN starts-->
                                                                                              <%if @TotalTSRIN.to_i>=0%>
                                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=blue><b><%= @TotalTSRIN%></b></font></td>
                                                                                              <%else%>
                                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=red><b><%= @TotalTSRIN%></b></font></td>
                                                                                              <%end%>
                                                                                              <!--total TSRIN end-->
                                                                                              <!--total TSROUT starts-->
                                                                                              <%if @TotalTSROUT.to_i>=0%>
                                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=blue><b><%= @TotalTSROUT %></b></font></td>
                                                                                              <%else%>
                                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=red><b><%= @TotalTSROUT%></b></font></td>
                                                                                              <%end%>
                                                                                              <!--total TSROUT end-->

          <!--<td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3><b><% @TotalTSROUT%></b></font></td>-->
                                                                                              <!--total  MCSHORT starts-->
                                                                                              <%if @TotalMCSHORT.to_i>=0%>
                                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=blue><b><%= @TotalMCSHORT %></b></font></td>

                                                                                              <%else%>
                                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=red><b><%= @TotalMCSHORT%></b></font></td>
                                                                                              <%end%>
                                                                                              <!--total MCSHORT end-->

          <!--<td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3><b><% @TotalMCSHORT%></b></font></td>-->
                                                                                              <!--total  Coll starts-->
                                                                                              <%if @TotalCOLL.to_i>=0%>
                                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=blue><b><%= @TotalCOLL %></b></font></td>
                                                                                              <%else%>
                                                                                                <td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3 color=red><b><%= @TotalCOLL%></b></font></td>
                                                                                              <%end%>
                                                                                              <!--total Coll end-->

          <!----<td nowrap height="10" align=center bgcolor="#E7CF7C"><font size=3><b><% @TotalCOLL%></b></font></td>-->
                                                                                              <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                              <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                              <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                              <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                              <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                              <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>
                                                                                              <td nowrap height="10" align=center bgcolor="#E7CF7C">&nbsp;</td>

                                                                                            </tr>
                                                                                            <tr>
                                                                                              <td></td>
                                                                                              <td></td>
                                                                                              <td></td>
                                                                                              <td></td>
                                                                                              <td></td>
                                                                                              <td></td>
                                                                                              <td></td>
                                                                                              <td><b>COLL</b></td>
  <%# @keydata=Counterdata.find(:first,:conditions=>["ClusterName in (?) and SHOP_NAME=? AND GROUP_ID=? and TRANS_DATE=?",@session[:clustarray],@session[:shoparray1][i].to_s,key.GroupID,session[:dailyvalue]],:order => "MACHINE_NAME,digitno,charno") %>
                                                                                              <%@keydata= Counterdata.find(:first,:conditions=>["ClusterName in (?) and ShopName=? and Date=? ",@session[:clustarray],@session[:shoparray1][i].to_s,session[:dailyvalue]])%>

                                                                                              <td><%= (@keydata.KEY1.to_i+@keydata.KEY2.to_i+@keydata.KEY3.to_i+@keydata.KEY4.to_i)%>&nbsp;</td>
                                                                                              <% @keyd= (@keydata.KEY1.to_i+@keydata.KEY2.to_i+@keydata.KEY3.to_i+@keydata.KEY4.to_i)%>

                                                                                            </tr>

                                                                                            <tr>
                                                                                              <td></td>
                                                                                              <td></td>
                                                                                              <td></td>
                                                                                              <td></td>
                                                                                              <td></td>
                                                                                              <td></td>
                                                                                              <td></td>
                                                                                              <td><b>S/E</b></td>
                                                                                              <% @val= (@keyd.to_i-@TotalCOLL.to_i) %>
                                                                                              <% if @val.to_i<0%>
                                                                                                <td align=center><b><font color= red size=3><%= @val %></b></font>&nbsp;</td>
                                                                                        <%else%>
                                                                                          <td align=center><font size=3><b><%= @val %>&nbsp;</b></td>
                                                                                        <% end %>
                                                                                        <%@shp=@session[:shoparray1][i].to_s%>


                                                                                        </tr>
                                                                                        <tr>
                                                                                            <td></td>
                                                                                                <td></td>
                                                                                                <td></td>
                                                                                                <td></td>
                                                                                                <td></td>
                                                                                                <td></td>
                                                                                                <td></td>
                                                                                                 <%@mneg1=0%>
                                                                                                <% @mpos1 =0 %>
                                                                                                <%if @TotalMCSHORT.to_i<0 %>
                                                                                                            <% @mneg1= @mneg1.to_i+@TotalMCSHORT.to_i%>
                                                                                                          <% else %>
                                                                                                            <% @mpos1= @mpos1.to_i+@TotalMCSHORT.to_i%>
                                                                                                          <% end %>
                                                                                                        <% if @TotalTSRIN!=0 %>
                                                                                                          <% @totalper=((@TotalTSROUT.to_f-@mneg1.to_f)*100)/(@TotalTSRIN.to_f+@mpos1.to_f)%>
                                                                                                        <% else %>
                                                                                                          <% @totalper=0%>
                                                                                                        <% end %>
                                                                                                <td><b>PERCENT</b></td>
                                                                                                <td align="center"><font size="3"><%= (@totalper.to_f).round %>%</b></font></td>

                                                                                          </tr>

                                                                                        </table>
                                                                                        <br>




                                                                                        <!-- ***************************************************** M/C COUNT % & AVG ******************************* -->

                                                                                        <table  border="1" width ="95%"  cellpadding="0"  cellspacing="0"  bordercolor="black"   id="AutoNumber1" >
                                                                                          <% @mnamea=[]%>
                                                                                          <tr bgcolor="#E7CF7C">
                                                                                            <% Machinedata.find(:all,:select=>'distinct MACHINE_NAME',:conditions=>["CLUSTER_NAME in (?)
      and SHOP_NAME =?
      and TRANS_DATE>=?
      and TRANS_DATE<=?",
                                                                                                @session[:clustarray],
                                                                                                @shp,
                                                                                                @session[:startdatehc],
                                                                                                session[:dailyvalue]],
                                                                                              :order=>'MACHINE_NAME').each do |mdata|%>



                                                                                              <%@machinecount=Machinedata.count(:conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? and TRANS_DATE=?  and MACHINE_NAME=?",
                                                                                                  @session[:clustarray],@shp,session[:dailyvalue],mdata.MACHINE_NAME])%>
                                                                                              <% @mnamea<<mdata.MACHINE_NAME %>
                                                                                              <th height="20" bgcolor="#E7CF7C" ><%= mdata.MACHINE_NAME%>-<%= @machinecount %></th>
                                                                                            <% end %>
                                                                                          </tr>

                                                                                          <tr>
                                                                                            <% @counter=0 %>
                                                                                            <% @ctval=0  %>
                                                                                            <% for @counter in 0..(@mnamea.length-1)%>
                                                                                              <% @tsrin=0 %>
                                                                                              <% @tsrinvalue=0 %>
                                                                                              <% @tsrout=0 %>
                                                                                              <% @mtrpos=0 %>
                                                                                              <% @mtrneg=0 %>
    <%# @mnamea[@counter]='ljp' %>

                                                                                              <%Machinedata.find(:all,
                                                                                                :conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? and TRANS_DATE<=? and TRANS_DATE>=? and MACHINE_NAME=?",
                                                                                                  @session[:clustarray],@shp,session[:dailyvalue],@session[:startdatehc],@mnamea[@counter]],
                                                                                                :order=>'Group_ID').each do |adata|%>

                                                                                                <% if adata.CALCULATEBY!='M'
                                                                                                  @tsrin=(@tsrin+adata.TSRIN.to_i*adata.MULTIPLY_BY.to_i*adata.SCREEN_RATE_IN.to_i) %>
        <%#	@tsrout=@tsrout+adata.TSROUT.to_i %>
                                                                                                  <% @tsrout=(@tsrout+adata.TSROUT.to_i*adata.MULTIPLY_BY.to_i*adata.SCREEN_RATE_OUT.to_i) %>
                                                                                                <% else %>
                                                                                                  <% @tsrin=@tsrin+adata.TMTRIN.to_i*adata.MULTIPLY_BY.to_i*adata.SCREEN_RATE_IN.to_i %>
        <%# @tsrout=@tsrout+adata.TMTROUT.to_i %>
                                                                                                  <% @tsrout=(@tsrout+adata.TMTROUT.to_i*adata.MULTIPLY_BY.to_i*adata.SCREEN_RATE_OUT.to_i) %>

                                                                                                <% end %>
                                                                                                <% if adata.MTRSHORT.to_i < 0 %>
                                                                                                  <% @mtrneg=@mtrneg+adata.MTRSHORT.to_i %>
                                                                                                <% else
                                                                                                  @mtrpos=@mtrpos+adata.MTRSHORT.to_i
                                                                                                end%>
                                                                                              <% end %>

                                                                                              <% @tsrin=@tsrin/10 %>
                                                                                              <% @tsrout=@tsrout/10 %>

                                                                                              <td align=center width="950"><B><font size="3">
                                                                                                    <% if @tsrin!=0 %>
                                                                                                      <span><%=  (((@tsrout.to_f-@mtrneg.to_f)*100)/(@tsrin.to_f+@mtrpos.to_f)).round%>%</span>
                                                                                                      <% else %>
                                                                                                        <%= 0 %>
                                                                                                      <% end %>
                                                                                                      <% @mnamea[@counter]%>
                                                                                                      <%@machinecount=Machinedata.count(:conditions=>["CLUSTER_NAME in (?) and SHOP_NAME=? and TRANS_DATE=?  and MACHINE_NAME=?",@session[:clustarray],@shp,session[:dailyvalue],@mnamea[@counter]])%>

                                                                                                      <% if @machinecount!=0 %>
                                                                                                        <% avg = (((((@tsrin.to_f+@mtrpos.to_f)-(@tsrout.to_f-(@mtrneg.to_f)))/@machinecount)/@session[:datediff].to_i)).round %>
                                                                                                      <%else%>
                                                                                                        <%avg = 0%>
                                                                                                      <% end %>

                                                                                                      <% if avg < 0 %>
                                                                                                        <span><font color=red><%= avg %></font></span>
                                                                                                      <% elsif avg == 0 %>
                                                                                                        <span> - </span>
                                                                                                      <%else%>
                                                                                                        <span><%= avg %></span>
                                                                                                      <% end %>
                                                                                                      </B>
                                                                                                  </font>
                                                                                              </td>
                                                                                              <% @counter=@counter+1%>
                                                                                            <% end %>
                                                                                          </tr>
                                                                                        </table>

                                                                                        <!-- ***************************************************** M/C COUNT % & AVG ******************************* -->


                                                                                        <% @total_tsrin=@total_tsrin.to_i+@TotalTSRIN.to_i%>
                                                                                        <% @total_tsrout=@total_tsrout.to_i+@TotalTSROUT.to_i%>
  <%#end%>

                                                                                        <% shopcount=shopcount.to_i+1%>

                                                                                        <BR><BR><BR><BR>
                                                                                      <% end %>


                                                                                      <%  if @TotalMCSHORT.to_i >= 0 %>
                                                                                        <% @TOTALSHOPPER=((@total_tsrout.to_f*100)/(@total_tsrin.to_f+@TotalMCSHORT.to_i)).round %>
                                                                                      <% else %>
                                                                                        <% @TOTALSHOPPER=(((@total_tsrout.to_f-@TotalMCSHORT.to_i)*100)/(@total_tsrin.to_f)).round %>
                                                                                      <% end %>

                                                                                      <table align=center>
                                                                                        <tr><td ><font size=5>TODAY'S TOTAL % FOR <%= shopcount%> SHOPES :</td><td><font size=5>
                                                                                              <!-- display % start-->
                                                                                              <%if @TOTALSHOPPER.to_i <=59%>
                                                                                                <font color= red><%=@TOTALSHOPPER %>%</font></td>
                                                                                                  <%elsif @TOTALSHOPPER.to_i >59 and @TOTALSHOPPER.to_i <=69%>
                                                                                                  <font color= blue><%= @TOTALSHOPPER %>%</font></td>
                                                                                                    <%elsif @TOTALSHOPPER.to_i >69 and @TOTALSHOPPER.to_i <=80%>
                                                                                                    <font color= green><%= @TOTALSHOPPER %>%</font></td>
                                                                                                      <%elsif @TOTALSHOPPER.to_i >=81%>
                                                                                                      <font color= red><%=@TOTALSHOPPER %>%</font></td>
                                                                                                        <%end%>
                                                                                                      <!-- display % end-->
                                                                                                      </tr>
                                                                                                      </table>


                                                                                                      </body>

                                                                                                      </html>